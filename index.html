<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MessageMe</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f0f2f5;
      --text-primary: #050505;
      --text-secondary: #65676b;
      --accent: #1877f2;
      --border: #dddfe2;
      --online: #31a24c;
      --notification: #ff3b30;
      --group: #8a2be2;
    }

    .theme-dark {
      --bg-primary: #242526;
      --bg-secondary: #18191a;
      --text-primary: #e4e6eb;
      --text-secondary: #b0b3b8;
      --accent: #2d88ff;
      --border: #3e4042;
      --online: #31a24c;
      --notification: #ff3b30;
      --group: #9b51e0;
    }

    body {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .bg-primary {
      background-color: var(--bg-primary);
    }

    .bg-secondary {
      background-color: var(--bg-secondary);
    }

    .text-primary {
      color: var(--text-primary);
    }

    .text-secondary {
      color: var(--text-secondary);
    }

    .border-primary {
      border-color: var(--border);
    }

    .accent {
      background-color: var(--accent);
    }

    .chat-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      word-break: break-word;
    }

    .chat-bubble.sent {
      background-color: var(--accent);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.received {
      background-color: var(--bg-secondary);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .online-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online);
      position: absolute;
      bottom: 0;
      right: 0;
      border: 2px solid var(--bg-primary);
    }

    .active-friend {
      background-color: rgba(45, 136, 255, 0.1);
    }

    .logo {
      background: linear-gradient(135deg, #00b4ff 0%, #0066ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }

    .search-highlight {
      background-color: rgba(0, 180, 255, 0.2);
      padding: 0 2px;
      border-radius: 3px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--notification);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }

    .notification-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      width: 280px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .notification-popup.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification-popup .sender {
      font-weight: bold;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .notification-popup .message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .notification-popup .time {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: right;
    }

    .notification-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: var(--bg-primary);
      border-radius: 14px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal.show .modal-content {
      transform: translateY(0);
    }

    .friend-select-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .friend-select-item:hover {
      background-color: var(--bg-secondary);
    }

    .friend-select-item.selected {
      background-color: rgba(45, 136, 255, 0.2);
    }

    .group-member-tag {
      display: inline-flex;
      align-items: center;
      background-color: var(--bg-secondary);
      padding: 6px 12px;
      border-radius: 20px;
      margin-right: 6px;
      margin-bottom: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .group-member-tag i {
      margin-left: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .group-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      margin-left: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .group-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .group-icon:active {
      transform: scale(0.95);
    }

    /* Image preview in messages */
    .message-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message-image:hover {
      transform: scale(1.02);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .w-80 {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 20;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .w-80.show {
        transform: translateX(0);
      }

      .chat-section {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 30;
      }

      .chat-section.active {
        display: flex;
      }

      .group-chat-section {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 30;
      }

      .group-chat-section.active {
        display: flex;
      }

      .chat-bubble {
        max-width: 85%;
      }

      .notification-popup {
        width: 90%;
        right: 5%;
        bottom: 80px;
      }

      .empty-state {
        z-index: 10;
      }
    }

    /* Enhanced UI Elements */
    .user-menu-item {
      transition: all 0.2s ease;
      padding: 10px 16px;
      border-radius: 6px;
    }

    .user-menu-item:hover {
      background-color: var(--bg-secondary);
    }

    .message-input {
      transition: all 0.2s ease;
      padding: 12px 16px;
      font-size: 15px;
    }

    .message-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .friend-item {
      transition: all 0.2s ease;
      padding: 12px 16px;
    }

    .friend-item:hover {
      background-color: var(--bg-secondary);
    }

    .request-item {
      transition: all 0.2s ease;
    }

    .request-item:hover {
      background-color: var(--bg-secondary);
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background-color: #166fe5;
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background-color: var(--border);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-secondary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }

    .slide-up {
      animation: slideUp 0.3s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Pulsing animation for notifications */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 0.5s ease infinite;
    }

    /* Image preview modal */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .image-modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
    }

    .image-modal-content img {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }

    /* Attachment menu */
    .attachment-menu {
      position: absolute;
      bottom: 80px;
      left: 20px;
      background-color: var(--bg-primary);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    .attachment-menu.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .attachment-item {
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }

    .attachment-item:hover {
      background-color: var(--bg-secondary);
    }

    .attachment-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
  </style>
</head>
<body class="theme-light">
  <div id="app" class="h-screen flex flex-col overflow-hidden">
    <!-- Login Screen -->
    <div id="login" class="flex items-center justify-center h-full p-4">
      <div class="bg-primary p-8 rounded-xl shadow-xl w-full max-w-md">
        <div class="text-center mb-8">
          <div class="flex items-center justify-center mb-4">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white shadow-lg">
              <i class="fas fa-comment-alt text-3xl"></i>
            </div>
          </div>
          <h1 class="text-3xl font-bold logo mb-2">MessageMe</h1>
          <p class="text-secondary">Connect with friends and family</p>
        </div>
        <div class="mb-6">
          <input 
            type="text" 
            id="username" 
            placeholder="Enter username" 
            class="w-full p-4 border-primary border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-primary text-primary message-input"
            autocomplete="username"
          />
        </div>
        <button 
          onclick="loginUser()" 
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-xl transition duration-200 btn-primary"
        >
          Login
        </button>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden h-full flex flex-col">
      <!-- Header -->
      <header class="bg-primary border-b border-primary py-3 px-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center">
          <button id="menuToggle" class="md:hidden mr-2 text-secondary hover:bg-secondary w-10 h-10 rounded-full flex items-center justify-center">
            <i class="fas fa-bars text-lg"></i>
          </button>
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white shadow-md">
            <i class="fas fa-comment-alt text-sm"></i>
          </div>
          <h1 class="text-xl font-bold logo ml-2">MessageMe</h1>
        </div>
        <div class="flex items-center space-x-3">
          <div class="flex items-center relative">
            <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-md">
              <span id="currentUserInitial">U</span>
            </div>
            <span class="ml-2 font-medium hidden md:inline" id="currentUser"></span>
            <div id="createGroupBtn" class="group-icon hidden">
              <i class="fas fa-users"></i>
            </div>
            <div id="userMenuBtn" class="ml-2 cursor-pointer w-8 h-8 flex items-center justify-center rounded-full hover:bg-secondary">
              <i class="fas fa-chevron-down text-secondary"></i>
            </div>
            <div id="userMenu" class="absolute right-0 top-12 bg-primary border border-primary rounded-xl shadow-xl w-48 z-50 hidden slide-up">
              <ul class="py-1">
                <li class="px-4 py-3 user-menu-item" id="logoutBtn">
                  <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </li>
              </ul>
            </div>
          </div>
          <button 
            onclick="toggleTheme()" 
            class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary"
            title="Toggle theme"
          >
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <div class="flex-1 overflow-hidden relative">
        <!-- Sidebar -->
        <div id="sidebar" class="w-80 border-r border-primary bg-primary flex flex-col md:block absolute md:relative h-full z-10">
          <!-- Search -->
          <div class="p-3 border-b border-primary">
            <div class="relative">
              <input 
                type="text" 
                id="searchInput" 
                placeholder="Search messages" 
                class="w-full bg-secondary text-primary py-3 px-4 pl-12 rounded-xl focus:outline-none message-input"
                oninput="searchMessages()"
              />
              <i class="fas fa-search absolute left-4 top-4 text-secondary"></i>
            </div>
          </div>

          <!-- Friend Requests Section -->
          <div class="p-3 border-b border-primary">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-semibold text-lg">Friend Requests</h3>
              <div class="flex items-center">
                <span id="requestCount" class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full mr-2 hidden">0</span>
                <button onclick="toggleRequests()" class="text-secondary hover:bg-secondary w-8 h-8 rounded-full flex items-center justify-center">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
            <ul id="requestsList" class="space-y-2"></ul>
          </div>

          <!-- Friends List -->
          <div class="flex-1 overflow-y-auto">
            <h3 class="font-semibold p-3 text-lg">Chats</h3>
            <ul id="friendsList" class="space-y-1"></ul>
          </div>

          <!-- Add Friend Section -->
          <div class="p-3 border-t border-primary">
            <h3 class="font-semibold mb-2 text-lg">Add Friend</h3>
            <div class="flex">
              <input 
                type="text" 
                id="friendName" 
                placeholder="Friend username" 
                class="flex-1 bg-secondary text-primary py-3 px-4 rounded-l-xl focus:outline-none message-input"
              />
              <button 
                onclick="sendRequest()" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 rounded-r-xl transition btn-primary"
                title="Send friend request"
              >
                <i class="fas fa-user-plus"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div id="chatSection" class="flex-1 flex flex-col bg-secondary h-full chat-section">
          <!-- Chat Header -->
          <div class="bg-primary border-b border-primary p-3 flex items-center shadow-sm">
            <button 
              id="backButton" 
              onclick="hideChat()" 
              class="md:hidden mr-2 text-secondary hover:bg-secondary w-10 h-10 rounded-full flex items-center justify-center"
            >
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="flex items-center">
              <div class="relative">
                <div class="w-12 h-12 rounded-full bg-gray-400 flex items-center justify-center text-white shadow-md">
                  <span id="chatWithInitial" class="text-xl">F</span>
                </div>
                <div id="friendStatus" class="online-dot hidden"></div>
              </div>
              <div class="ml-3">
                <h2 id="chatWith" class="font-semibold text-lg"></h2>
                <p id="friendStatusText" class="text-xs text-secondary">Offline</p>
              </div>
            </div>
          </div>

          <!-- Messages -->
          <div id="chatBox" class="flex-1 p-4 overflow-y-auto space-y-3"></div>

          <!-- Message Input -->
          <div class="bg-primary border-t border-primary p-3 shadow-md relative">
            <div class="flex items-center">
              <button 
                id="attachmentBtn"
                class="w-12 h-12 rounded-full bg-secondary flex items-center justify-center mr-2 hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary"
              >
                <i class="fas fa-plus text-secondary"></i>
              </button>
              <input 
                type="text" 
                id="message" 
                placeholder="Type a message" 
                class="flex-1 bg-secondary text-primary py-3 px-4 rounded-xl focus:outline-none message-input"
                onkeypress="if(event.keyCode === 13) sendMessage()"
              />
              <button 
                onclick="sendMessage()" 
                class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white ml-2 hover:bg-blue-600 transition btn-primary"
                title="Send message"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            
            <!-- Attachment menu -->
            <div id="attachmentMenu" class="attachment-menu">
              <div class="attachment-item" onclick="showImageInput()">
                <i class="fas fa-image"></i>
                <span>Send Image</span>
              </div>
            </div>
            
            <!-- Hidden image input -->
            <input 
              type="text" 
              id="imageUrlInput" 
              placeholder="Paste image URL" 
              class="hidden w-full bg-secondary text-primary py-3 px-4 rounded-xl mt-2 focus:outline-none message-input"
              onkeypress="if(event.keyCode === 13) sendImageMessage()"
            />
            <div class="hidden flex justify-end mt-2" id="imageUrlButtons">
              <button 
                onclick="hideImageInput()" 
                class="px-4 py-2 rounded-lg bg-secondary hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary mr-2"
              >
                Cancel
              </button>
              <button 
                onclick="sendImageMessage()" 
                class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition btn-primary"
              >
                Send
              </button>
            </div>
          </div>
        </div>

        <!-- Group Chat Area -->
        <div id="groupChatSection" class="flex-1 flex flex-col bg-secondary h-full chat-section">
          <!-- Group Chat Header -->
          <div class="bg-primary border-b border-primary p-3 flex items-center shadow-sm">
            <button 
              id="backButtonGroup" 
              onclick="hideGroupChat()" 
              class="md:hidden mr-2 text-secondary hover:bg-secondary w-10 h-10 rounded-full flex items-center justify-center"
            >
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="flex items-center">
              <div class="relative">
                <div class="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center text-white shadow-md">
                  <i class="fas fa-users text-lg"></i>
                </div>
              </div>
              <div class="ml-3">
                <h2 id="groupChatName" class="font-semibold text-lg"></h2>
                <p id="groupMembersCount" class="text-xs text-secondary">0 members</p>
              </div>
            </div>
          </div>

          <!-- Group Messages -->
          <div id="groupChatBox" class="flex-1 p-4 overflow-y-auto space-y-3"></div>

          <!-- Group Message Input -->
          <div class="bg-primary border-t border-primary p-3 shadow-md relative">
            <div class="flex items-center">
              <button 
                id="groupAttachmentBtn"
                class="w-12 h-12 rounded-full bg-secondary flex items-center justify-center mr-2 hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary"
              >
                <i class="fas fa-plus text-secondary"></i>
              </button>
              <input 
                type="text" 
                id="groupMessage" 
                placeholder="Type a message" 
                class="flex-1 bg-secondary text-primary py-3 px-4 rounded-xl focus:outline-none message-input"
                onkeypress="if(event.keyCode === 13) sendGroupMessage()"
              />
              <button 
                onclick="sendGroupMessage()" 
                class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white ml-2 hover:bg-blue-600 transition btn-primary"
                title="Send message"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            
            <!-- Group attachment menu -->
            <div id="groupAttachmentMenu" class="attachment-menu">
              <div class="attachment-item" onclick="showGroupImageInput()">
                <i class="fas fa-image"></i>
                <span>Send Image</span>
              </div>
            </div>
            
            <!-- Hidden group image input -->
            <input 
              type="text" 
              id="groupImageUrlInput" 
              placeholder="Paste image URL" 
              class="hidden w-full bg-secondary text-primary py-3 px-4 rounded-xl mt-2 focus:outline-none message-input"
              onkeypress="if(event.keyCode === 13) sendGroupImageMessage()"
            />
            <div class="hidden flex justify-end mt-2" id="groupImageUrlButtons">
              <button 
                onclick="hideGroupImageInput()" 
                class="px-4 py-2 rounded-lg bg-secondary hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary mr-2"
              >
                Cancel
              </button>
              <button 
                onclick="sendGroupImageMessage()" 
                class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition btn-primary"
              >
                Send
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="flex-1 flex items-center justify-center bg-secondary empty-state">
          <div class="text-center p-6 max-w-md">
            <div class="w-24 h-24 bg-primary rounded-full flex items-center justify-center mx-auto mb-6 shadow-md">
              <i class="fas fa-comment-dots text-4xl text-secondary"></i>
            </div>
            <h3 class="text-2xl font-semibold mb-3">Your messages</h3>
            <p class="text-secondary mb-6">Select a friend or group to start chatting</p>
            <button 
              onclick="document.getElementById('friendName').focus()" 
              class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition btn-primary"
            >
              <i class="fas fa-user-plus mr-2"></i>Add Friend
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Popup -->
    <div id="notificationPopup" class="notification-popup">
      <button class="close-btn" onclick="closeNotification()">
        <i class="fas fa-times"></i>
      </button>
      <div class="sender"></div>
      <div class="message"></div>
      <div class="time"></div>
    </div>
    
    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
      <div class="modal-content">
        <h3 class="font-bold text-xl mb-4">Create New Group</h3>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Group Name</label>
          <input 
            type="text" 
            id="groupNameInput" 
            placeholder="Enter group name" 
            class="w-full bg-secondary text-primary py-3 px-4 rounded-xl focus:outline-none message-input"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Select Friends</label>
          <div id="selectedFriends" class="flex flex-wrap mb-3"></div>
          <div id="friendsSelectList" class="max-h-40 overflow-y-auto"></div>
        </div>
        <div class="flex justify-end space-x-3">
          <button 
            onclick="closeCreateGroupModal()" 
            class="px-5 py-3 rounded-xl bg-secondary hover:bg-gray-200 dark:hover:bg-gray-700 transition btn-secondary"
          >
            Cancel
          </button>
          <button 
            onclick="createGroup()" 
            class="px-5 py-3 rounded-xl bg-blue-500 hover:bg-blue-600 text-white transition btn-primary"
          >
            Create Group
          </button>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="image-modal">
      <div class="image-modal-close" onclick="closeImageModal()">
        <i class="fas fa-times"></i>
      </div>
      <div class="image-modal-content">
        <img id="modalImage" src="" alt="Preview">
      </div>
    </div>

    <!-- Audio element for notification sound -->
    <audio id="notificationSound" preload="auto">
      <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBJ0r_Nb9IplADBNNsFIgbqb01kcbGvuso",
    authDomain: "we-call-430e1.firebaseapp.com",
    databaseURL: "https://we-call-430e1-default-rtdb.firebaseio.com",
    projectId: "we-call-430e1",
    storageBucket: "we-call-430e1.appspot.com",
    messagingSenderId: "398312328918",
    appId: "1:398312328918:web:4ce69dd9927a9e5b9fc377",
    measurementId: "G-S3QGZ2M8RX"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = "";
  let chattingWith = "";
  let currentGroup = "";
  let friendStatusInterval;
  let allMessages = {};
  let allGroupMessages = {};
  let messageListeners = {};
  let groupMessageListeners = {};
  let unreadMessages = {};
  let unreadGroupMessages = {};
  let lastMessageTimestamps = {};
  let lastGroupMessageTimestamps = {};
  let selectedFriendsForGroup = [];
  let friendsList = [];
  let isMobile = window.innerWidth <= 768;

  // Check for existing session on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedUser = localStorage.getItem('messageMeUser');
    if (savedUser) {
      document.getElementById("username").value = savedUser;
      loginUser();
    }
    
    // Setup logout button
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      logout();
    });
    
    // Setup menu toggle for mobile
    document.getElementById('menuToggle').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('show');
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      isMobile = window.innerWidth <= 768;
      adjustChatSections();
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      if (isMobile && !document.getElementById('sidebar').contains(e.target) && 
          !document.getElementById('menuToggle').contains(e.target)) {
        document.getElementById('sidebar').classList.remove('show');
      }
      
      // Close attachment menus
      if (!document.getElementById('attachmentBtn').contains(e.target)) {
        document.getElementById('attachmentMenu').classList.remove('show');
      }
      if (!document.getElementById('groupAttachmentBtn').contains(e.target)) {
        document.getElementById('groupAttachmentMenu').classList.remove('show');
      }
    });

    // Setup attachment buttons
    document.getElementById('attachmentBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('attachmentMenu').classList.toggle('show');
    });
    
    document.getElementById('groupAttachmentBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('groupAttachmentMenu').classList.toggle('show');
    });

    // Initialize chat sections
    adjustChatSections();
  });

  function adjustChatSections() {
    if (isMobile) {
      document.getElementById('chatSection').classList.remove('active');
      document.getElementById('groupChatSection').classList.remove('active');
      document.getElementById('emptyState').classList.remove('hidden');
    } else {
      document.getElementById('chatSection').classList.remove('hidden');
      document.getElementById('groupChatSection').classList.remove('hidden');
    }
  }

  function loginUser() {
    const user = document.getElementById("username").value.trim();
    if (!user) {
      showToast("Please enter a username");
      return;
    }

    currentUser = user;
    document.getElementById("currentUser").textContent = user;
    document.getElementById("currentUserInitial").textContent = user.charAt(0).toUpperCase();

    // Save user to localStorage for persistent login
    localStorage.setItem('messageMeUser', user);
    
    db.ref(`users/${user}`).set({ 
      online: true, 
      lastActive: Date.now(),
      name: user
    });
    
    document.getElementById("login").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("createGroupBtn").classList.remove("hidden");

    loadRequests();
    loadFriends();
    loadGroups();
    updateActivity();
    setupMessageNotifications();
    
    // Show welcome toast
    showToast(`Welcome back, ${user}!`);
  }

  function logout() {
    if (currentUser) {
      db.ref(`users/${currentUser}`).update({ online: false });
    }
    
    // Clear all listeners
    Object.values(messageListeners).forEach(off => off());
    Object.values(groupMessageListeners).forEach(off => off());
    if (friendStatusInterval) clearInterval(friendStatusInterval);
    
    // Clear local variables but keep data in Firebase
    chattingWith = "";
    currentGroup = "";
    allMessages = {};
    allGroupMessages = {};
    messageListeners = {};
    groupMessageListeners = {};
    unreadMessages = {};
    unreadGroupMessages = {};
    lastMessageTimestamps = {};
    lastGroupMessageTimestamps = {};
    selectedFriendsForGroup = [];
    friendsList = [];
    
    // Hide dashboard and show login
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("login").classList.remove("hidden");
    
    // Close user menu
    document.getElementById("userMenu").classList.add("hidden");
    
    // Keep the username in the input field for easy relogin
    document.getElementById("username").focus();
  }

  function updateActivity() {
    // Update every 30 seconds
    setInterval(() => {
      if (currentUser) {
        db.ref(`users/${currentUser}`).update({ lastActive: Date.now() });
      }
    }, 30000);
  }

  function sendRequest() {
    const friend = document.getElementById("friendName").value.trim();
    if (!friend || friend === currentUser) {
      showToast("Invalid username");
      return;
    }

    // Check if user exists
    db.ref(`users/${friend}`).once('value').then(snapshot => {
      if (!snapshot.exists()) {
        showToast("User not found");
        return;
      }
      
      // Check if already friends
      db.ref(`friends/${currentUser}/${friend}`).once('value').then(friendSnapshot => {
        if (friendSnapshot.exists()) {
          showToast("You are already friends with this user");
          return;
        }
        
        // Check if request already sent
        db.ref(`requests/${friend}/${currentUser}`).once('value').then(requestSnapshot => {
          if (requestSnapshot.exists()) {
            showToast("Friend request already sent");
            return;
          }
          
          // Send request
          db.ref(`requests/${friend}/${currentUser}`).set({
            from: currentUser,
            timestamp: Date.now()
          });
          
          document.getElementById("friendName").value = "";
          showToast(`Friend request sent to ${friend}`);
        });
      });
    }).catch(error => {
      console.error("Error checking user:", error);
      showToast("Error checking user");
    });
  }

  function loadRequests() {
    db.ref(`requests/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("requestsList");
      list.innerHTML = "";
      const requestCount = Object.keys(data).length;
      
      // Update request count badge
      const requestBadge = document.getElementById("requestCount");
      if (requestCount > 0) {
        requestBadge.textContent = requestCount;
        requestBadge.classList.remove("hidden");
      } else {
        requestBadge.classList.add("hidden");
      }

      Object.entries(data).forEach(([requester, requestData]) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between p-3 hover:bg-secondary rounded-lg transition request-item";
        
        li.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white mr-3 shadow-sm">
              ${requester.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="font-medium">${requester}</div>
              <div class="text-xs text-secondary">${formatDate(requestData.timestamp)}</div>
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="acceptRequest('${requester}')" class="text-white bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-lg text-sm transition btn-primary">
              Accept
            </button>
            <button onclick="declineRequest('${requester}')" class="text-secondary hover:bg-secondary px-3 py-2 rounded-lg text-sm transition btn-secondary">
              Decline
            </button>
          </div>
        `;
        list.appendChild(li);
      });
    });
  }

  function acceptRequest(user) {
    db.ref(`friends/${currentUser}/${user}`).set({
      since: Date.now()
    });
    db.ref(`friends/${user}/${currentUser}`).set({
      since: Date.now()
    });
    db.ref(`requests/${currentUser}/${user}`).remove();
    showToast(`You are now friends with ${user}`);
    loadFriends();
  }

  function declineRequest(user) {
    db.ref(`requests/${currentUser}/${user}`).remove();
    showToast(`Friend request from ${user} declined`);
  }

  function loadFriends() {
    db.ref(`friends/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("friendsList");
      list.innerHTML = "";
      friendsList = Object.keys(data);

      // Clear previous message listeners
      Object.values(messageListeners).forEach(off => off());
      messageListeners = {};
      
      // Initialize unread messages for each friend
      Object.keys(data).forEach(friend => {
        if (!unreadMessages[friend]) {
          unreadMessages[friend] = 0;
        }
      });

      Object.entries(data).forEach(([friend, friendData]) => {
        const li = document.createElement("li");
        li.className = "flex items-center p-3 hover:bg-secondary rounded-lg cursor-pointer transition friend-item relative";
        li.id = `friend-${friend}`;
        
        const friendRef = db.ref(`users/${friend}`);
        friendRef.on("value", snapshot => {
          const info = snapshot.val();
          const isActive = info && Date.now() - info.lastActive < 60000;
          
          // Add unread badge if there are unread messages
          const unreadBadge = unreadMessages[friend] > 0 
            ? `<div class="notification-badge">${unreadMessages[friend]}</div>` 
            : '';
          
          li.innerHTML = `
            <div class="relative mr-3">
              <div class="w-12 h-12 rounded-full bg-gray-400 flex items-center justify-center text-white shadow-sm">
                ${friend.charAt(0).toUpperCase()}
              </div>
              ${isActive ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center">
                <span class="font-medium truncate">${friend}</span>
                <span class="text-xs text-secondary whitespace-nowrap ml-2">${formatDate(friendData.since)}</span>
              </div>
              <p class="text-xs text-secondary truncate">
                ${isActive ? 'Active now' : 'Last seen recently'}
              </p>
            </div>
            ${unreadBadge}
          `;
          
          li.onclick = () => {
            startChat(friend);
            if (isMobile) {
              document.getElementById('sidebar').classList.remove('show');
            }
          };
        });
        
        list.appendChild(li);
        
        // Setup message listener for this friend
        setupMessageListener(friend);
      });
    });
  }

  function loadGroups() {
    db.ref(`userGroups/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("friendsList");
      
      // Clear previous group message listeners
      Object.values(groupMessageListeners).forEach(off => off());
      groupMessageListeners = {};
      
      // Initialize unread messages for each group
      Object.keys(data).forEach(groupId => {
        if (!unreadGroupMessages[groupId]) {
          unreadGroupMessages[groupId] = 0;
        }
        
        // Setup group message listener
        setupGroupMessageListener(groupId);
        
        // Add group to friends list
        db.ref(`groups/${groupId}`).once("value").then(groupSnapshot => {
          const groupData = groupSnapshot.val();
          if (!groupData) return;
          
          const li = document.createElement("li");
          li.className = "flex items-center p-3 hover:bg-secondary rounded-lg cursor-pointer transition friend-item relative";
          li.id = `group-${groupId}`;
          
          // Count members
          const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
          
          // Add unread badge if there are unread messages
          const unreadBadge = unreadGroupMessages[groupId] > 0 
            ? `<div class="notification-badge">${unreadGroupMessages[groupId]}</div>` 
            : '';
          
          li.innerHTML = `
            <div class="relative mr-3">
              <div class="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center text-white shadow-sm">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center">
                <span class="font-medium truncate">${groupData.name}</span>
                <span class="text-xs text-secondary whitespace-nowrap ml-2">${formatDate(groupData.createdAt || Date.now())}</span>
              </div>
              <p class="text-xs text-secondary truncate">
                ${memberCount} member${memberCount !== 1 ? 's' : ''}
              </p>
            </div>
            ${unreadBadge}
          `;
          
          li.onclick = () => {
            startGroupChat(groupId);
            if (isMobile) {
              document.getElementById('sidebar').classList.remove('show');
            }
          };
          list.appendChild(li);
        });
      });
    });
  }

  function setupMessageListener(friend) {
    const chatKey = [currentUser, friend].sort().join('_');
    
    // Remove previous listener if exists
    if (messageListeners[friend]) {
      messageListeners[friend]();
    }
    
    // Add new listener
    messageListeners[friend] = db.ref(`messages/${chatKey}`).on("value", snap => {
      const messages = snap.val() || {};
      const lastMessage = Object.values(messages).pop();
      
      if (!lastMessage) return;
      
      // Store last message timestamp for this chat
      lastMessageTimestamps[friend] = lastMessage.timestamp || Date.now();
      
      // If the message is not from current user and chat is not open with this friend
      if (lastMessage.from !== currentUser && chattingWith !== friend) {
        // Increment unread count
        unreadMessages[friend] = (unreadMessages[friend] || 0) + 1;
        
        // Update friend list item
        updateFriendListItem(friend);
        
        // Show notification
        showMessageNotification(friend, lastMessage.text, lastMessage.timestamp, lastMessage.imageUrl);
      }
    });
  }

  function setupGroupMessageListener(groupId) {
    // Remove previous listener if exists
    if (groupMessageListeners[groupId]) {
      groupMessageListeners[groupId]();
    }
    
    // Add new listener
    groupMessageListeners[groupId] = db.ref(`groupMessages/${groupId}`).on("value", snap => {
      const messages = snap.val() || {};
      const lastMessage = Object.values(messages).pop();
      
      if (!lastMessage) return;
      
      // Store last message timestamp for this group
      lastGroupMessageTimestamps[groupId] = lastMessage.timestamp || Date.now();
      
      // If the message is not from current user and group is not open
      if (lastMessage.from !== currentUser && currentGroup !== groupId) {
        // Increment unread count
        unreadGroupMessages[groupId] = (unreadGroupMessages[groupId] || 0) + 1;
        
        // Update group list item
        updateGroupListItem(groupId);
        
        // Show notification
        showMessageNotification(lastMessage.from + " (Group)", lastMessage.text, lastMessage.timestamp, lastMessage.imageUrl);
      }
    });
  }

  function updateFriendListItem(friend) {
    const friendItem = document.getElementById(`friend-${friend}`);
    if (!friendItem) return;
    
    const friendRef = db.ref(`users/${friend}`);
    friendRef.once("value").then(snapshot => {
      const info = snapshot.val();
      const isActive = info && Date.now() - info.lastActive < 60000;
      
      // Add unread badge if there are unread messages
      const unreadBadge = unreadMessages[friend] > 0 
        ? `<div class="notification-badge">${unreadMessages[friend]}</div>` 
        : '';
      
      friendItem.innerHTML = `
        <div class="relative mr-3">
          <div class="w-12 h-12 rounded-full bg-gray-400 flex items-center justify-center text-white shadow-sm">
            ${friend.charAt(0).toUpperCase()}
          </div>
          ${isActive ? '<div class="online-dot"></div>' : ''}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-center">
            <span class="font-medium truncate">${friend}</span>
            <span class="text-xs text-secondary whitespace-nowrap ml-2">${formatDate(lastMessageTimestamps[friend] || Date.now())}</span>
          </div>
          <p class="text-xs text-secondary truncate">
            ${isActive ? 'Active now' : 'Last seen recently'}
          </p>
        </div>
        ${unreadBadge}
      `;
      
      friendItem.onclick = () => {
        startChat(friend);
        if (isMobile) {
          document.getElementById('sidebar').classList.remove('show');
        }
      };
    });
  }

  function updateGroupListItem(groupId) {
    const groupItem = document.getElementById(`group-${groupId}`);
    if (!groupItem) return;
    
    db.ref(`groups/${groupId}`).once("value").then(snapshot => {
      const groupData = snapshot.val();
      if (!groupData) return;
      
      // Count members
      const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
      
      // Add unread badge if there are unread messages
      const unreadBadge = unreadGroupMessages[groupId] > 0 
        ? `<div class="notification-badge">${unreadGroupMessages[groupId]}</div>` 
        : '';
      
      groupItem.innerHTML = `
        <div class="relative mr-3">
          <div class="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center text-white shadow-sm">
            <i class="fas fa-users"></i>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-center">
            <span class="font-medium truncate">${groupData.name}</span>
            <span class="text-xs text-secondary whitespace-nowrap ml-2">${formatDate(lastGroupMessageTimestamps[groupId] || groupData.createdAt || Date.now())}</span>
          </div>
          <p class="text-xs text-secondary truncate">
            ${memberCount} member${memberCount !== 1 ? 's' : ''}
          </p>
        </div>
        ${unreadBadge}
      `;
      
      groupItem.onclick = () => {
        startGroupChat(groupId);
        if (isMobile) {
          document.getElementById('sidebar').classList.remove('show');
        }
      };
    });
  }

  function setupMessageNotifications() {
    // Handle browser tab visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // Clear any notifications when tab becomes active
        document.title = "MessageMe";
      }
    });
  }

  function showMessageNotification(sender, message, timestamp, imageUrl) {
    // Update browser tab title
    const unreadCount = unreadMessages[sender] || unreadGroupMessages[sender] || 1;
    document.title = `(${unreadCount}) New message from ${sender} | MessageMe`;
    
    // Show popup notification
    const popup = document.getElementById("notificationPopup");
    popup.querySelector('.sender').textContent = sender;
    
    if (imageUrl) {
      popup.querySelector('.message').innerHTML = '<i class="fas fa-image mr-1"></i> Image';
    } else {
      popup.querySelector('.message').textContent = message.length > 80 ? message.substring(0, 80) + '...' : message;
    }
    
    popup.querySelector('.time').textContent = formatTime(timestamp);
    
    popup.classList.add("show");
    
    // Play notification sound
    playNotificationSound();
    
    // Vibrate if on mobile
    if (navigator.vibrate) {
      navigator.vibrate(200);
    }
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      popup.classList.remove("show");
    }, 5000);
  }

  function playNotificationSound() {
    const audio = document.getElementById("notificationSound");
    audio.volume = 0.3;
    audio.currentTime = 0;
    audio.play().catch(e => console.log("Audio play failed:", e));
  }

  function closeNotification() {
    document.getElementById("notificationPopup").classList.remove("show");
  }

  function startChat(user) {
    chattingWith = user;
    currentGroup = "";
    
    if (isMobile) {
      document.getElementById("chatSection").classList.add("active");
      document.getElementById("groupChatSection").classList.remove("active");
      document.getElementById("emptyState").classList.add("hidden");
    } else {
      document.getElementById("chatSection").classList.remove("hidden");
      document.getElementById("groupChatSection").classList.add("hidden");
      document.getElementById("emptyState").classList.add("hidden");
    }
    
    document.getElementById("chatWith").textContent = user;
    document.getElementById("chatWithInitial").textContent = user.charAt(0).toUpperCase();
    
    // Reset unread count for this friend
    unreadMessages[user] = 0;
    updateFriendListItem(user);
    
    // Update browser title
    document.title = `MessageMe - Chat with ${user}`;
    
    // Monitor friend's status
    monitorFriendStatus(user);
    
    const chatKey = [currentUser, user].sort().join('_');
    db.ref(`messages/${chatKey}`).on("value", snap => {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      const data = snap.val() || {};
      allMessages[user] = data; // Store messages for search
      
      Object.entries(data).forEach(([key, msg]) => {
        const isSent = msg.from === currentUser;
        const div = document.createElement("div");
        div.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
        
        let messageContent = `<p>${msg.text}</p>`;
        if (msg.imageUrl) {
          messageContent = `
            <p>${msg.text || ''}</p>
            <img src="${msg.imageUrl}" alt="Sent image" class="message-image" onclick="showFullImage('${msg.imageUrl}')">
          `;
        }
        
        div.innerHTML = `
          <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
            ${messageContent}
            <p class="text-xs mt-1 ${isSent ? 'text-blue-100' : 'text-secondary'} text-right">
              ${formatTime(msg.timestamp || Date.now())}
            </p>
          </div>
        `;
        
        chatBox.appendChild(div);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function startGroupChat(groupId) {
    currentGroup = groupId;
    chattingWith = "";
    
    if (isMobile) {
      document.getElementById("groupChatSection").classList.add("active");
      document.getElementById("chatSection").classList.remove("active");
      document.getElementById("emptyState").classList.add("hidden");
    } else {
      document.getElementById("groupChatSection").classList.remove("hidden");
      document.getElementById("chatSection").classList.add("hidden");
      document.getElementById("emptyState").classList.add("hidden");
    }
    
    // Reset unread count for this group
    unreadGroupMessages[groupId] = 0;
    updateGroupListItem(groupId);
    
    // Load group info
    db.ref(`groups/${groupId}`).once("value").then(snapshot => {
      const groupData = snapshot.val();
      if (!groupData) return;
      
      document.getElementById("groupChatName").textContent = groupData.name;
      
      // Count members
      const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
      document.getElementById("groupMembersCount").textContent = `${memberCount} member${memberCount !== 1 ? 's' : ''}`;
      
      // Update browser title
      document.title = `MessageMe - ${groupData.name}`;
    });
    
    // Load group messages
    db.ref(`groupMessages/${groupId}`).on("value", snap => {
      const chatBox = document.getElementById("groupChatBox");
      chatBox.innerHTML = "";
      const data = snap.val() || {};
      allGroupMessages[groupId] = data; // Store messages for search
      
      Object.entries(data).forEach(([key, msg]) => {
        const isSent = msg.from === currentUser;
        const div = document.createElement("div");
        div.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
        
        let messageContent = `<p>${msg.text}</p>`;
        if (msg.imageUrl) {
          messageContent = `
            <p>${msg.text || ''}</p>
            <img src="${msg.imageUrl}" alt="Sent image" class="message-image" onclick="showFullImage('${msg.imageUrl}')">
          `;
        }
        
        div.innerHTML = `
          <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
            <p class="font-bold ${!isSent ? 'text-purple-500' : ''}">${isSent ? 'You' : msg.from}</p>
            ${messageContent}
            <p class="text-xs mt-1 ${isSent ? 'text-blue-100' : 'text-secondary'} text-right">
              ${formatTime(msg.timestamp || Date.now())}
            </p>
          </div>
        `;
        
        chatBox.appendChild(div);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function searchMessages() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (!searchTerm) return;
    
    let foundMessages = [];
    
    // Search through all messages
    Object.entries(allMessages).forEach(([friend, messages]) => {
      Object.entries(messages).forEach(([key, msg]) => {
        if (msg.text && msg.text.toLowerCase().includes(searchTerm)) {
          foundMessages.push({
            friend,
            message: msg
          });
        }
      });
    });
    
    // Search through group messages
    Object.entries(allGroupMessages).forEach(([groupId, messages]) => {
      Object.entries(messages).forEach(([key, msg]) => {
        if (msg.text && msg.text.toLowerCase().includes(searchTerm)) {
          db.ref(`groups/${groupId}`).once("value").then(snapshot => {
            const groupData = snapshot.val();
            foundMessages.push({
              groupId,
              groupName: groupData.name,
              message: msg
            });
          });
        }
      });
    });
    
    // Display search results
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";
    
    if (foundMessages.length === 0) {
      chatBox.innerHTML = `
        <div class="flex items-center justify-center h-full">
          <p class="text-secondary">No messages found</p>
        </div>
      `;
      return;
    }
    
    foundMessages.forEach(item => {
      const isSent = item.message.from === currentUser;
      const div = document.createElement("div");
      div.className = `flex ${isSent ? 'justify-end' : 'justify-start'} mb-4`;
      
      // Highlight the search term in the message
      const messageText = item.message.text.replace(
        new RegExp(searchTerm, 'gi'),
        match => `<span class="search-highlight">${match}</span>`
      );
      
      if (item.groupId) {
        // Group message result
        div.innerHTML = `
          <div class="max-w-xs">
            <div class="text-xs text-secondary mb-1">
              Group: ${item.groupName} • ${formatTime(item.message.timestamp)}
            </div>
            <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
              <p class="font-bold ${!isSent ? 'text-purple-500' : ''}">${isSent ? 'You' : item.message.from}</p>
              <p>${messageText}</p>
            </div>
          </div>
        `;
        
        div.onclick = () => {
          startGroupChat(item.groupId);
          document.getElementById('searchInput').value = '';
          if (isMobile) {
            document.getElementById('sidebar').classList.remove('show');
          }
        };
      } else {
        // Private message result
        div.innerHTML = `
          <div class="max-w-xs">
            <div class="text-xs text-secondary mb-1">
              Chat with ${item.friend} • ${formatTime(item.message.timestamp)}
            </div>
            <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
              <p>${messageText}</p>
            </div>
          </div>
        `;
        
        div.onclick = () => {
          startChat(item.friend);
          document.getElementById('searchInput').value = '';
          if (isMobile) {
            document.getElementById('sidebar').classList.remove('show');
          }
        };
      }
      
      chatBox.appendChild(div);
    });
  }

  function monitorFriendStatus(friend) {
    // Clear any existing interval
    if (friendStatusInterval) clearInterval(friendStatusInterval);
    
    const friendRef = db.ref(`users/${friend}`);
    const statusDot = document.getElementById("friendStatus");
    const statusText = document.getElementById("friendStatusText");
    
    friendRef.on("value", snapshot => {
      const info = snapshot.val();
      const isActive = info && Date.now() - info.lastActive < 60000;
      
      statusDot.classList.toggle("hidden", !isActive);
      statusText.textContent = isActive ? "Active now" : "Last seen recently";
      statusText.className = `text-xs ${isActive ? 'text-green-500' : 'text-secondary'}`;
      
      // Highlight friend in friends list
      const friendElement = document.getElementById(`friend-${friend}`);
      if (friendElement) {
        friendElement.classList.toggle("active-friend", isActive);
      }
    });
    
    // Check status every 10 seconds
    friendStatusInterval = setInterval(() => {
      friendRef.once("value").then(snapshot => {
        const info = snapshot.val();
        const isActive = info && Date.now() - info.lastActive < 60000;
        
        statusDot.classList.toggle("hidden", !isActive);
        statusText.textContent = isActive ? "Active now" : "Last seen recently";
        statusText.className = `text-xs ${isActive ? 'text-green-500' : 'text-secondary'}`;
      });
    }, 10000);
  }

  function hideChat() {
    if (isMobile) {
      document.getElementById("chatSection").classList.remove("active");
      document.getElementById("emptyState").classList.remove("hidden");
    } else {
      document.getElementById("chatSection").classList.add("hidden");
      document.getElementById("emptyState").classList.remove("hidden");
    }
    document.title = "MessageMe";
    if (friendStatusInterval) clearInterval(friendStatusInterval);
  }

  function hideGroupChat() {
    if (isMobile) {
      document.getElementById("groupChatSection").classList.remove("active");
      document.getElementById("emptyState").classList.remove("hidden");
    } else {
      document.getElementById("groupChatSection").classList.add("hidden");
      document.getElementById("emptyState").classList.remove("hidden");
    }
    document.title = "MessageMe";
  }

  function sendMessage() {
    const text = document.getElementById("message").value.trim();
    if (!text || !chattingWith) return;

    const chatKey = [currentUser, chattingWith].sort().join('_');
    db.ref(`messages/${chatKey}`).push({ 
      from: currentUser, 
      text,
      timestamp: Date.now()
    });
    
    document.getElementById("message").value = "";
  }

  function sendGroupMessage() {
    const text = document.getElementById("groupMessage").value.trim();
    if (!text || !currentGroup) return;

    db.ref(`groupMessages/${currentGroup}`).push({ 
      from: currentUser, 
      text,
      timestamp: Date.now()
    });
    
    document.getElementById("groupMessage").value = "";
  }

  // Image message functions
  function showImageInput() {
    document.getElementById('attachmentMenu').classList.remove('show');
    document.getElementById('imageUrlInput').classList.remove('hidden');
    document.getElementById('imageUrlButtons').classList.remove('hidden');
    document.getElementById('imageUrlInput').focus();
  }

  function hideImageInput() {
    document.getElementById('imageUrlInput').classList.add('hidden');
    document.getElementById('imageUrlButtons').classList.add('hidden');
    document.getElementById('imageUrlInput').value = '';
  }

  function sendImageMessage() {
    const imageUrl = document.getElementById("imageUrlInput").value.trim();
    if (!imageUrl || !chattingWith) return;

    // Validate URL
    try {
      new URL(imageUrl);
    } catch (e) {
      showToast("Please enter a valid image URL");
      return;
    }

    const chatKey = [currentUser, chattingWith].sort().join('_');
    db.ref(`messages/${chatKey}`).push({ 
      from: currentUser, 
      imageUrl,
      timestamp: Date.now()
    });
    
    hideImageInput();
  }

  function showGroupImageInput() {
    document.getElementById('groupAttachmentMenu').classList.remove('show');
    document.getElementById('groupImageUrlInput').classList.remove('hidden');
    document.getElementById('groupImageUrlButtons').classList.remove('hidden');
    document.getElementById('groupImageUrlInput').focus();
  }

  function hideGroupImageInput() {
    document.getElementById('groupImageUrlInput').classList.add('hidden');
    document.getElementById('groupImageUrlButtons').classList.add('hidden');
    document.getElementById('groupImageUrlInput').value = '';
  }

  function sendGroupImageMessage() {
    const imageUrl = document.getElementById("groupImageUrlInput").value.trim();
    if (!imageUrl || !currentGroup) return;

    // Validate URL
    try {
      new URL(imageUrl);
    } catch (e) {
      showToast("Please enter a valid image URL");
      return;
    }

    db.ref(`groupMessages/${currentGroup}`).push({ 
      from: currentUser, 
      imageUrl,
      timestamp: Date.now()
    });
    
    hideGroupImageInput();
  }

  function showFullImage(url) {
    document.getElementById('modalImage').src = url;
    document.getElementById('imageModal').classList.add('show');
  }

  function closeImageModal() {
    document.getElementById('imageModal').classList.remove('show');
  }

  function toggleTheme() {
    document.body.classList.toggle("theme-dark");
    document.body.classList.toggle("theme-light");
    
    const icon = document.querySelector('[onclick="toggleTheme()"] i');
    if (document.body.classList.contains("theme-dark")) {
      icon.classList.remove("fa-moon");
      icon.classList.add("fa-sun");
    } else {
      icon.classList.remove("fa-sun");
      icon.classList.add("fa-moon");
    }
  }

  function toggleRequests() {
    const list = document.getElementById("requestsList");
    list.classList.toggle("hidden");
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      return 'Today';
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return date.toLocaleDateString([], { weekday: 'short' });
    } else {
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }
  }

  function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-xl shadow-lg z-50 fade-in";
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add("opacity-0", "transition-opacity", "duration-300");
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Group creation functions
  function showCreateGroupModal() {
    const modal = document.getElementById("createGroupModal");
    modal.classList.add("show");
    
    // Populate friends list
    const friendsSelect = document.getElementById("friendsSelectList");
    friendsSelect.innerHTML = "";
    
    friendsList.forEach(friend => {
      const item = document.createElement("div");
      item.className = "friend-select-item";
      item.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white text-sm mr-3">
          ${friend.charAt(0).toUpperCase()}
        </div>
        <span class="truncate">${friend}</span>
      `;
      
      item.onclick = () => {
        item.classList.toggle("selected");
        if (item.classList.contains("selected")) {
          if (!selectedFriendsForGroup.includes(friend)) {
            selectedFriendsForGroup.push(friend);
          }
        } else {
          selectedFriendsForGroup = selectedFriendsForGroup.filter(f => f !== friend);
        }
        updateSelectedFriendsDisplay();
      };
      
      friendsSelect.appendChild(item);
    });
  }

  function closeCreateGroupModal() {
    document.getElementById("createGroupModal").classList.remove("show");
    document.getElementById("groupNameInput").value = "";
    selectedFriendsForGroup = [];
    document.getElementById("selectedFriends").innerHTML = "";
  }

  function updateSelectedFriendsDisplay() {
    const container = document.getElementById("selectedFriends");
    container.innerHTML = "";
    
    selectedFriendsForGroup.forEach(friend => {
      const tag = document.createElement("div");
      tag.className = "group-member-tag";
      tag.innerHTML = `
        ${friend}
        <i class="fas fa-times" onclick="removeSelectedFriend('${friend}')"></i>
      `;
      container.appendChild(tag);
    });
  }

  function removeSelectedFriend(friend) {
    selectedFriendsForGroup = selectedFriendsForGroup.filter(f => f !== friend);
    updateSelectedFriendsDisplay();
    
    // Also unselect from the list
    const items = document.querySelectorAll(".friend-select-item");
    items.forEach(item => {
      if (item.textContent.includes(friend)) {
        item.classList.remove("selected");
      }
    });
  }

  function createGroup() {
    const groupName = document.getElementById("groupNameInput").value.trim();
    if (!groupName) {
      showToast("Please enter a group name");
      return;
    }
    
    if (selectedFriendsForGroup.length === 0) {
      showToast("Please select at least one friend");
      return;
    }
    
    // Create group
    const groupRef = db.ref("groups").push();
    const groupId = groupRef.key;
    
    // Prepare members object (including current user)
    const members = {};
    members[currentUser] = true;
    selectedFriendsForGroup.forEach(friend => {
      members[friend] = true;
    });
    
    // Set group data
    groupRef.set({
      name: groupName,
      createdAt: Date.now(),
      createdBy: currentUser,
      members: members
    });
    
    // Add group to each user's groups
    Object.keys(members).forEach(user => {
      db.ref(`userGroups/${user}/${groupId}`).set(true);
    });
    
    // Close modal and reset
    closeCreateGroupModal();
    showToast(`Group "${groupName}" created successfully`);
    
    // Start chatting in the new group
    startGroupChat(groupId);
  }

  // Event listeners
  document.getElementById("userMenuBtn").addEventListener("click", function(e) {
    e.stopPropagation();
    document.getElementById("userMenu").classList.toggle("hidden");
  });

  document.addEventListener("click", function() {
    document.getElementById("userMenu").classList.add("hidden");
  });

  document.getElementById("userMenu").addEventListener("click", function(e) {
    e.stopPropagation();
  });

  document.getElementById("createGroupBtn").addEventListener("click", showCreateGroupModal);

  // Close image modal when clicking outside
  document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeImageModal();
    }
  });
</script>
</body>
</html>
