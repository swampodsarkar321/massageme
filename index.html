<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MessageMe</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f0f2f5;
      --text-primary: #050505;
      --text-secondary: #65676b;
      --accent: #1877f2;
      --border: #dddfe2;
      --online: #31a24c;
      --notification: #ff3b30;
      --group: #8a2be2;
      --call: #31a24c;
      --video-call: #ff3b30;
      --reaction-bg: rgba(0, 0, 0, 0.5);
    }

    .theme-dark {
      --bg-primary: #242526;
      --bg-secondary: #18191a;
      --text-primary: #e4e6eb;
      --text-secondary: #b0b3b8;
      --accent: #2d88ff;
      --border: #3e4042;
      --online: #31a24c;
      --notification: #ff3b30;
      --group: #9b51e0;
      --call: #31a24c;
      --video-call: #ff3b30;
      --reaction-bg: rgba(255, 255, 255, 0.1);
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      -webkit-tap-highlight-color: transparent;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background-color: var(--bg-primary);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
    }

    .logo {
      font-weight: 700;
      font-size: 20px;
      background: linear-gradient(135deg, #00b4ff 0%, #0066ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .menu-button {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      padding: 8px;
    }

    .user-button {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-primary);
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 8px;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .sidebar {
      width: 280px;
      background-color: var(--bg-primary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 20;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .search-bar {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .search-input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border-radius: 20px;
      border: none;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .search-icon {
      position: absolute;
      left: 25px;
      top: 22px;
      color: var(--text-secondary);
    }

    .friend-requests {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .section-title {
      font-weight: 600;
      font-size: 16px;
    }

    .badge {
      background-color: var(--accent);
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: bold;
    }

    .request-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }

    .request-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e4e6eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      color: var(--text-primary);
      font-weight: bold;
    }

    .request-info {
      flex: 1;
    }

    .request-name {
      font-weight: 500;
      font-size: 14px;
    }

    .request-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .request-actions {
      display: flex;
    }

    .accept-btn, .decline-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      margin-left: 5px;
    }

    .accept-btn {
      background-color: var(--accent);
      color: white;
    }

    .decline-btn {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .friends-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .friend-item {
      display: flex;
      align-items: center;
      padding: 10px 8px;
      border-radius: 8px;
      margin-bottom: 4px;
      position: relative;
      cursor: pointer;
    }

    .friend-item:hover {
      background-color: var(--bg-secondary);
    }

    .friend-item.active {
      background-color: rgba(45, 136, 255, 0.1);
    }

    .friend-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #e4e6eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--text-primary);
      font-weight: bold;
      font-size: 18px;
      position: relative;
    }

    .online-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--online);
      position: absolute;
      bottom: 0;
      right: 0;
      border: 2px solid var(--bg-primary);
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: 500;
      font-size: 15px;
    }

    .friend-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .friend-time {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 8px;
    }

    .unread-badge {
      background-color: var(--notification);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      position: absolute;
      right: 12px;
    }

    .add-friend {
      padding: 12px;
      border-top: 1px solid var(--border);
    }

    .add-friend-input {
      display: flex;
    }

    .add-friend-input input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 20px 0 0 20px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .add-friend-input button {
      padding: 12px 16px;
      border: none;
      border-radius: 0 20px 20px 0;
      background-color: var(--accent);
      color: white;
      font-weight: 500;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-header {
      background-color: var(--bg-primary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .back-button {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      margin-right: 12px;
      padding: 8px;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e4e6eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--text-primary);
      font-weight: bold;
      position: relative;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 500;
      font-size: 16px;
    }

    .chat-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: var(--bg-secondary);
    }

    .message {
      max-width: 70%;
      margin-bottom: 8px;
      position: relative;
    }

    .message.sent {
      margin-left: auto;
    }

    .message.received {
      margin-right: auto;
    }

    .message-bubble {
      padding: 8px 12px;
      border-radius: 18px;
      word-break: break-word;
      position: relative;
    }

    .message.sent .message-bubble {
      background-color: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.received .message-bubble {
      background-color: var(--bg-primary);
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
      text-align: right;
    }

    .message-input-container {
      background-color: var(--bg-primary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border);
    }

    .message-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: none;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      margin: 0 8px;
    }

    .send-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
      background-color: var(--bg-secondary);
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: var(--text-secondary);
      font-size: 32px;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .add-friend-btn {
      padding: 12px 24px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      display: flex;
      align-items: center;
    }

    .add-friend-btn i {
      margin-right: 8px;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      width: 280px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification-header {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .notification-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: right;
    }

    .close-notification {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: var(--bg-primary);
      border-radius: 14px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal.show .modal-content {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .modal-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: none;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 15px;
      margin-bottom: 16px;
    }

    .selected-friends {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .friend-tag {
      background-color: var(--bg-secondary);
      padding: 6px 12px;
      border-radius: 20px;
      margin-right: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
    }

    .remove-tag {
      margin-left: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .friend-select {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .friend-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
    }

    .friend-option:hover {
      background-color: var(--bg-secondary);
    }

    .friend-option.selected {
      background-color: rgba(45, 136, 255, 0.2);
    }

    .friend-option-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #e4e6eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      color: var(--text-primary);
      font-weight: bold;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
    }

    .cancel-btn, .create-btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 500;
      border: none;
      margin-left: 8px;
      cursor: pointer;
    }

    .cancel-btn {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    .create-btn {
      background-color: var(--accent);
      color: white;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--bg-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 40px;
    }

    .made-by {
      position: absolute;
      bottom: 30px;
      color: var(--text-secondary);
      font-size: 14px;
      opacity: 0;
      animation: fadeIn 2s ease 1s forwards;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .group-avatar {
      background-color: var(--group);
      color: white;
    }

    .group-message-name {
      font-weight: bold;
      color: var(--group);
      margin-bottom: 4px;
      font-size: 13px;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      padding: 8px;
      margin-left: 8px;
      cursor: pointer;
    }

    .create-group-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      padding: 8px;
      margin-left: 8px;
      cursor: pointer;
    }
    
    .login-animation {
      animation: loginFadeIn 1.5s ease forwards;
    }
    
    @keyframes loginFadeIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    .logout-btn {
      width: 100%;
      text-align: left;
      padding: 10px 16px;
      background: none;
      border: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .logout-btn:hover {
      background-color: var(--bg-secondary);
    }
    
    .logout-btn i {
      margin-right: 8px;
    }
    
    .image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: none;
    }
    
    .image-preview.show {
      display: block;
    }
    
    .remove-image-btn {
      background-color: var(--notification);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    /* Call buttons */
    .call-buttons {
      display: flex;
      margin-left: auto;
    }
    
    .call-btn, .video-call-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 18px;
      padding: 8px;
      margin-left: 8px;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .call-btn:hover {
      background-color: rgba(49, 162, 76, 0.1);
      color: var(--call);
    }
    
    .video-call-btn:hover {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--video-call);
    }

    /* Reactions */
    .reaction-container {
      position: absolute;
      bottom: -10px;
      right: 0;
      background-color: var(--reaction-bg);
      border-radius: 20px;
      padding: 4px;
      display: none;
      z-index: 10;
    }
    
    .message:hover .reaction-container {
      display: block;
    }
    
    .reaction-btn {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      padding: 4px;
      cursor: pointer;
    }
    
    .reaction-display {
      position: absolute;
      top: -20px;
      right: 10px;
      font-size: 14px;
      background-color: var(--reaction-bg);
      border-radius: 20px;
      padding: 2px 6px;
    }

    /* Call modal */
    .call-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .call-modal.show {
      opacity: 1;
      pointer-events: auto;
    }
    
    .caller-info {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .caller-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      margin: 0 auto 20px;
    }
    
    .caller-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      color: white;
    }
    
    .call-status {
      font-size: 16px;
      color: #ccc;
    }
    
    .call-actions {
      display: flex;
      justify-content: center;
      margin-top: 30px;
    }
    
    .call-action-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 15px;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: white;
    }
    
    .accept-call {
      background-color: var(--call);
    }
    
    .decline-call {
      background-color: var(--notification);
    }
    
    .end-call {
      background-color: var(--notification);
    }

    /* Video elements */
    .video-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      height: 450px;
      margin: 0 auto;
      background-color: black;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .remote-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .local-video {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 90px;
      border-radius: 4px;
      object-fit: cover;
      border: 2px solid white;
    }

    @media (min-width: 768px) {
      .sidebar {
        position: relative;
        transform: none;
      }

      .menu-button {
        display: none;
      }

      .back-button {
        display: none;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-secondary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Optimizations for performance */
    .friend-item, .message, .request-item {
      will-change: transform, opacity;
    }
    
    .messages-container, .friends-list {
      backface-visibility: hidden;
      transform: translate3d(0,0,0);
    }
  </style>
</head>
<body class="theme-light">
  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Loading MessageMe...</div>
    <div class="made-by">Made by Swampod</div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="app-container" style="display: none;">
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px;">
      <div class="login-animation" style="background-color: var(--bg-primary); padding: 24px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
        <div style="text-align: center; margin-bottom: 24px;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #00b4ff 0%, #0066ff 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <i class="fas fa-comment-alt" style="color: white; font-size: 32px;"></i>
          </div>
          <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #00b4ff 0%, #0066ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MessageMe</h1>
          <p style="color: var(--text-secondary);">Connect with friends and family</p>
        </div>
        <div style="margin-bottom: 20px;">
          <input 
            type="text" 
            id="username" 
            placeholder="Enter username" 
            style="width: 100%; padding: 14px 16px; border-radius: 8px; border: none; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 16px;"
            autocomplete="username"
          />
        </div>
        <button 
          onclick="loginUser()" 
          style="width: 100%; padding: 14px; background: linear-gradient(135deg, #00b4ff 0%, #0066ff 100%); color: white; border: none; border-radius: 8px; font-weight: 500; font-size: 16px; cursor: pointer;"
        >
          Login
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="app-container" style="display: none;">
    <!-- Header -->
    <header class="header">
      <button class="menu-button" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="logo">MessageMe</div>
      <div style="display: flex; align-items: center;">
        <button class="create-group-btn" onclick="showCreateGroupModal()" title="Create group">
          <i class="fas fa-users"></i>
        </button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
        <button class="user-button" onclick="toggleUserMenu()">
          <div class="avatar" id="currentUserInitial">U</div>
        </button>
      </div>
      
      <!-- User Menu -->
      <div id="userMenu" style="position: absolute; top: 60px; right: 16px; background-color: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; z-index: 100;">
        <div style="padding: 8px 0;">
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar -->
      <div id="sidebar" class="sidebar">
        <!-- Search -->
        <div class="search-bar">
          <div style="position: relative;">
            <i class="fas fa-search search-icon"></i>
            <input 
              type="text" 
              id="searchInput" 
              placeholder="Search messages" 
              class="search-input"
              oninput="searchMessages()"
            />
          </div>
        </div>

        <!-- Friend Requests -->
        <div class="friend-requests">
          <div class="section-header">
            <div class="section-title">Friend Requests</div>
            <div id="requestCount" class="badge" style="display: none;">0</div>
          </div>
          <div id="requestsList"></div>
        </div>

        <!-- Friends List -->
        <div class="friends-list">
          <div class="section-header">
            <div class="section-title">Chats</div>
          </div>
          <div id="friendsList"></div>
        </div>

        <!-- Add Friend -->
        <div class="add-friend">
          <div class="section-title">Add Friend</div>
          <div class="add-friend-input">
            <input 
              type="text" 
              id="friendName" 
              placeholder="Friend username" 
              style="flex: 1; padding: 10px 12px; border: none; border-radius: 20px 0 0 20px; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 14px;"
            />
            <button onclick="sendRequest()" style="padding: 10px 14px; border: none; border-radius: 0 20px 20px 0; background-color: var(--accent); color: white; font-weight: 500; cursor: pointer;">
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div id="chatArea" class="chat-area">
        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-comment-dots"></i>
          </div>
          <h3 class="empty-title">Your messages</h3>
          <p class="empty-text">Select a friend or group to start chatting</p>
          <button onclick="document.getElementById('friendName').focus()" class="add-friend-btn">
            <i class="fas fa-user-plus"></i> Add Friend
          </button>
        </div>

        <!-- Private Chat -->
        <div id="privateChat" style="display: none; height: 100%; flex-direction: column;">
          <div class="chat-header">
            <button class="back-button" onclick="hideChat()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-avatar" id="chatWithAvatar">
              <span id="chatWithInitial">F</span>
              <div id="friendStatus" class="online-dot" style="display: none;"></div>
            </div>
            <div class="chat-info">
              <div class="chat-name" id="chatWithName">Friend</div>
              <div class="chat-status" id="friendStatusText">Offline</div>
            </div>
            <div class="call-buttons">
              <button class="call-btn" onclick="startCall(false)" title="Voice call">
                <i class="fas fa-phone"></i>
              </button>
              <button class="video-call-btn" onclick="startCall(true)" title="Video call">
                <i class="fas fa-video"></i>
              </button>
            </div>
          </div>
          <div id="messagesContainer" class="messages-container">
            <div id="chatMessages"></div>
          </div>
          <div class="message-input-container">
            <button style="background: none; border: none; color: var(--text-primary); font-size: 20px; padding: 8px; cursor: pointer;" onclick="document.getElementById('imageInput').click()">
              <i class="fas fa-image"></i>
            </button>
            <input 
              type="file" 
              id="imageInput" 
              accept="image/*" 
              style="display: none;"
              onchange="handleImageUpload()"
            />
            <input 
              type="text" 
              id="messageInput" 
              placeholder="Type a message" 
              class="message-input"
              onkeypress="if(event.keyCode === 13) sendMessage()"
            />
            <button class="send-button" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div id="imagePreviewContainer" style="padding: 0 16px;"></div>
        </div>

        <!-- Group Chat -->
        <div id="groupChat" style="display: none; height: 100%; flex-direction: column;">
          <div class="chat-header">
            <button class="back-button" onclick="hideGroupChat()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-avatar group-avatar">
              <i class="fas fa-users"></i>
            </div>
            <div class="chat-info">
              <div class="chat-name" id="groupChatName">Group</div>
              <div class="chat-status" id="groupMembersCount">0 members</div>
            </div>
          </div>
          <div id="groupMessagesContainer" class="messages-container">
            <div id="groupMessages"></div>
          </div>
          <div class="message-input-container">
            <button style="background: none; border: none; color: var(--text-primary); font-size: 20px; padding: 8px; cursor: pointer;" onclick="document.getElementById('groupImageInput').click()">
              <i class="fas fa-image"></i>
            </button>
            <input 
              type="file" 
              id="groupImageInput" 
              accept="image/*" 
              style="display: none;"
              onchange="handleGroupImageUpload()"
            />
            <input 
              type="text" 
              id="groupMessageInput" 
              placeholder="Type a message" 
              class="message-input"
              onkeypress="if(event.keyCode === 13) sendGroupMessage()"
            />
            <button class="send-button" onclick="sendGroupMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div id="groupImagePreviewContainer" style="padding: 0 16px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <button class="close-notification" onclick="closeNotification()">
      <i class="fas fa-times"></i>
    </button>
    <div class="notification-header" id="notificationSender"></div>
    <div class="notification-message" id="notificationMessage"></div>
    <div class="notification-time" id="notificationTime"></div>
  </div>

  <!-- Create Group Modal -->
  <div id="createGroupModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Create New Group</h3>
      <input 
        type="text" 
        id="groupNameInput" 
        placeholder="Enter group name" 
        class="modal-input"
      />
      <div class="selected-friends" id="selectedFriends"></div>
      <div class="friend-select" id="friendsSelectList"></div>
      <div class="modal-actions">
        <button class="cancel-btn" onclick="closeCreateGroupModal()">Cancel</button>
        <button class="create-btn" onclick="createGroup()">Create</button>
      </div>
    </div>
  </div>

  <!-- Call Modal -->
  <div id="callModal" class="call-modal">
    <div class="video-container" id="videoContainer" style="display: none;">
      <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
      <video id="localVideo" class="local-video" autoplay playsinline muted></video>
    </div>
    
    <div class="caller-info" id="callerInfo">
      <div class="caller-avatar" id="callerAvatar">U</div>
      <div class="caller-name" id="callerName">Caller</div>
      <div class="call-status" id="callStatus">Calling...</div>
    </div>
    
    <div class="call-actions" id="callActions">
      <button class="call-action-btn accept-call" onclick="acceptCall()" style="display: none;">
        <i class="fas fa-phone"></i>
      </button>
      <button class="call-action-btn decline-call" onclick="endCall()">
        <i class="fas fa-phone-slash"></i>
      </button>
      <button class="call-action-btn end-call" onclick="endCall()" style="display: none;">
        <i class="fas fa-phone-slash"></i>
      </button>
    </div>
  </div>

  <!-- Audio for notifications -->
  <audio id="notificationSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
  </audio>
  
  <!-- Audio for calls -->
  <audio id="ringtone" loop preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-phone-ring-1127.mp3" type="audio/mpeg">
  </audio>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBJ0r_Nb9IplADBNNsFIgbqb01kcbGvuso",
    authDomain: "we-call-430e1.firebaseapp.com",
    databaseURL: "https://we-call-430e1-default-rtdb.firebaseio.com",
    projectId: "we-call-430e1",
    storageBucket: "we-call-430e1.appspot.com",
    messagingSenderId: "398312328918",
    appId: "1:398312328918:web:4ce69dd9927a9e5b9fc377",
    measurementId: "G-S3QGZ2M8RX"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // App state
  let currentUser = "";
  let chattingWith = "";
  let currentGroup = "";
  let friendStatusInterval;
  let allMessages = {};
  let allGroupMessages = {};
  let messageListeners = {};
  let groupMessageListeners = {};
  let unreadMessages = {};
  let unreadGroupMessages = {};
  let lastMessageTimestamps = {};
  let lastGroupMessageTimestamps = {};
  let selectedFriendsForGroup = [];
  let friendsList = [];
  let isMobile = window.innerWidth <= 768;
  let selectedImage = null;
  let selectedGroupImage = null;
  
  // Call state
  let peerConnection;
  let localStream;
  let remoteStream;
  let isCaller = false;
  let isVideoCall = false;
  let currentCallId = null;
  let callListener = null;
  let callStatusListener = null;
  let callIceCandidatesListener = null;

  // Initialize the app
  document.addEventListener('DOMContentLoaded', function() {
    // Check for saved user session
    const savedUser = localStorage.getItem('messageMeUser');
    if (savedUser) {
      document.getElementById("username").value = savedUser;
      loginUser();
    } else {
      // Show login screen after loading
      setTimeout(() => {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
      }, 1500);
    }

    // Setup mobile responsiveness
    window.addEventListener('resize', function() {
      isMobile = window.innerWidth <= 768;
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      if (isMobile && !document.getElementById('sidebar').contains(e.target) && 
          !document.querySelector('.menu-button').contains(e.target)) {
        document.getElementById('sidebar').classList.remove('open');
      }
      
      // Close user menu when clicking outside
      if (!document.querySelector('.user-button').contains(e.target) && 
          !document.getElementById('userMenu').contains(e.target)) {
        document.getElementById('userMenu').style.display = 'none';
      }
    });
  });

  // Toggle sidebar on mobile
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
  }

  // Toggle user menu
  function toggleUserMenu() {
    const menu = document.getElementById('userMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  // Login function
  function loginUser() {
    const user = document.getElementById("username").value.trim();
    if (!user) {
      showToast("Please enter a username");
      return;
    }

    currentUser = user;
    document.getElementById("currentUserInitial").textContent = user.charAt(0).toUpperCase();

    // Save user to localStorage for persistent login
    localStorage.setItem('messageMeUser', user);
    
    // Update user status in Firebase
    db.ref(`users/${user}`).set({ 
      online: true, 
      lastActive: Date.now(),
      name: user
    });
    
    // Switch to main app view
    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("app").style.display = "flex";

    // Load user data
    loadRequests();
    loadFriends();
    loadGroups();
    updateActivity();
    setupMessageNotifications();
    setupCallListener();
    
    // Show welcome message
    showToast(`Welcome back, ${user}!`);
  }

  // Logout function
  function logout() {
    if (currentUser) {
      db.ref(`users/${currentUser}`).update({ online: false });
    }
    
    // Clear all listeners
    Object.values(messageListeners).forEach(off => off());
    Object.values(groupMessageListeners).forEach(off => off());
    if (friendStatusInterval) clearInterval(friendStatusInterval);
    if (callListener) callListener();
    if (callStatusListener) callStatusListener();
    if (callIceCandidatesListener) callIceCandidatesListener();
    
    // End any active call
    endCall();
    
    // Reset app state
    currentUser = "";
    chattingWith = "";
    currentGroup = "";
    allMessages = {};
    allGroupMessages = {};
    messageListeners = {};
    groupMessageListeners = {};
    unreadMessages = {};
    unreadGroupMessages = {};
    lastMessageTimestamps = {};
    lastGroupMessageTimestamps = {};
    selectedFriendsForGroup = [];
    friendsList = [];
    selectedImage = null;
    selectedGroupImage = null;
    
    // Switch to login view
    document.getElementById("app").style.display = "none";
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("userMenu").style.display = "none";
    
    // Clear any active chats
    hideChat();
    hideGroupChat();
    
    // Clear localStorage
    localStorage.removeItem('messageMeUser');
    
    // Keep the username in the input field for easy relogin
    document.getElementById("username").focus();
  }

  // Update user activity periodically
  function updateActivity() {
    setInterval(() => {
      if (currentUser) {
        db.ref(`users/${currentUser}`).update({ lastActive: Date.now() });
      }
    }, 30000);
  }

  // Send friend request
  function sendRequest() {
    const friend = document.getElementById("friendName").value.trim();
    if (!friend || friend === currentUser) {
      showToast("Invalid username");
      return;
    }

    // Check if user exists
    db.ref(`users/${friend}`).once('value').then(snapshot => {
      if (!snapshot.exists()) {
        showToast("User not found");
        return;
      }
      
      // Check if already friends
      db.ref(`friends/${currentUser}/${friend}`).once('value').then(friendSnapshot => {
        if (friendSnapshot.exists()) {
          showToast("You are already friends with this user");
          return;
        }
        
        // Check if request already sent
        db.ref(`requests/${friend}/${currentUser}`).once('value').then(requestSnapshot => {
          if (requestSnapshot.exists()) {
            showToast("Friend request already sent");
            return;
          }
          
          // Send request
          db.ref(`requests/${friend}/${currentUser}`).set({
            from: currentUser,
            timestamp: Date.now()
          });
          
          document.getElementById("friendName").value = "";
          showToast(`Friend request sent to ${friend}`);
        });
      });
    }).catch(error => {
      console.error("Error checking user:", error);
      showToast("Error checking user");
    });
  }

  // Load friend requests
  function loadRequests() {
    db.ref(`requests/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("requestsList");
      list.innerHTML = "";
      const requestCount = Object.keys(data).length;
      
      // Update request count badge
      const requestBadge = document.getElementById("requestCount");
      if (requestCount > 0) {
        requestBadge.textContent = requestCount;
        requestBadge.style.display = "inline-block";
      } else {
        requestBadge.style.display = "none";
      }

      Object.entries(data).forEach(([requester, requestData]) => {
        const div = document.createElement("div");
        div.className = "request-item";
        
        div.innerHTML = `
          <div class="request-avatar">${requester.charAt(0).toUpperCase()}</div>
          <div class="request-info">
            <div class="request-name">${requester}</div>
            <div class="request-time">${formatDate(requestData.timestamp)}</div>
          </div>
          <div class="request-actions">
            <button class="accept-btn" onclick="acceptRequest('${requester}')">Accept</button>
            <button class="decline-btn" onclick="declineRequest('${requester}')">Decline</button>
          </div>
        `;
        list.appendChild(div);
      });
    });
  }

  // Accept friend request
  function acceptRequest(user) {
    db.ref(`friends/${currentUser}/${user}`).set({
      since: Date.now()
    });
    db.ref(`friends/${user}/${currentUser}`).set({
      since: Date.now()
    });
    db.ref(`requests/${currentUser}/${user}`).remove();
    showToast(`You are now friends with ${user}`);
    loadFriends();
  }

  // Decline friend request
  function declineRequest(user) {
    db.ref(`requests/${currentUser}/${user}`).remove();
    showToast(`Friend request from ${user} declined`);
  }

  // Load friends list
  function loadFriends() {
    db.ref(`friends/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("friendsList");
      list.innerHTML = "";
      friendsList = Object.keys(data);

      // Clear previous message listeners
      Object.values(messageListeners).forEach(off => off());
      messageListeners = {};
      
      // Initialize unread messages for each friend
      Object.keys(data).forEach(friend => {
        if (!unreadMessages[friend]) {
          unreadMessages[friend] = 0;
        }
      });

      Object.entries(data).forEach(([friend, friendData]) => {
        const div = document.createElement("div");
        div.className = "friend-item";
        div.id = `friend-${friend}`;
        
        const friendRef = db.ref(`users/${friend}`);
        friendRef.on("value", snapshot => {
          const info = snapshot.val();
          const isActive = info && Date.now() - info.lastActive < 60000;
          
          // Add unread badge if there are unread messages
          const unreadBadge = unreadMessages[friend] > 0 
            ? `<div class="unread-badge">${unreadMessages[friend]}</div>` 
            : '';
          
          div.innerHTML = `
            <div class="friend-avatar">
              ${friend.charAt(0).toUpperCase()}
              ${isActive ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="friend-info">
              <div class="friend-name">${friend}</div>
              <div class="friend-status">${isActive ? 'Active now' : 'Last seen recently'}</div>
            </div>
            <div class="friend-time">${formatDate(friendData.since)}</div>
            ${unreadBadge}
          `;
          
          div.onclick = () => {
            startChat(friend);
            if (isMobile) {
              document.getElementById('sidebar').classList.remove('open');
            }
          };
        });
        
        list.appendChild(div);
        
        // Setup message listener for this friend
        setupMessageListener(friend);
      });
    });
  }

  // Load groups the user is in
  function loadGroups() {
    db.ref(`userGroups/${currentUser}`).on("value", snap => {
      const data = snap.val() || {};
      const list = document.getElementById("friendsList");
      
      // Clear previous group message listeners
      Object.values(groupMessageListeners).forEach(off => off());
      groupMessageListeners = {};
      
      // Initialize unread messages for each group
      Object.keys(data).forEach(groupId => {
        if (!unreadGroupMessages[groupId]) {
          unreadGroupMessages[groupId] = 0;
        }
        
        // Setup group message listener
        setupGroupMessageListener(groupId);
        
        // Add group to friends list
        db.ref(`groups/${groupId}`).once("value").then(groupSnapshot => {
          const groupData = groupSnapshot.val();
          if (!groupData) return;
          
          const div = document.createElement("div");
          div.className = "friend-item";
          div.id = `group-${groupId}`;
          
          // Count members
          const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
          
          // Add unread badge if there are unread messages
          const unreadBadge = unreadGroupMessages[groupId] > 0 
            ? `<div class="unread-badge">${unreadGroupMessages[groupId]}</div>` 
            : '';
          
          div.innerHTML = `
            <div class="friend-avatar group-avatar">
              <i class="fas fa-users"></i>
            </div>
            <div class="friend-info">
              <div class="friend-name">${groupData.name}</div>
              <div class="friend-status">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="friend-time">${formatDate(groupData.createdAt || Date.now())}</div>
            ${unreadBadge}
          `;
          
          div.onclick = () => {
            startGroupChat(groupId);
            if (isMobile) {
              document.getElementById('sidebar').classList.remove('open');
            }
          };
          list.appendChild(div);
        });
      });
    });
  }

  // Setup listener for private messages with a friend
  function setupMessageListener(friend) {
    const chatKey = [currentUser, friend].sort().join('_');
    
    // Remove previous listener if exists
    if (messageListeners[friend]) {
      messageListeners[friend]();
    }
    
    // Add new listener
    messageListeners[friend] = db.ref(`messages/${chatKey}`).on("value", snap => {
      const messages = snap.val() || {};
      const lastMessage = Object.values(messages).pop();
      
      if (!lastMessage) return;
      
      // Store last message timestamp for this chat
      lastMessageTimestamps[friend] = lastMessage.timestamp || Date.now();
      
      // If the message is not from current user and chat is not open with this friend
      if (lastMessage.from !== currentUser && chattingWith !== friend) {
        // Increment unread count
        unreadMessages[friend] = (unreadMessages[friend] || 0) + 1;
        
        // Update friend list item
        updateFriendListItem(friend);
        
        // Show notification
        showMessageNotification(friend, lastMessage.text, lastMessage.timestamp);
      }
    });
  }

  // Setup listener for group messages
  function setupGroupMessageListener(groupId) {
    // Remove previous listener if exists
    if (groupMessageListeners[groupId]) {
      groupMessageListeners[groupId]();
    }
    
    // Add new listener
    groupMessageListeners[groupId] = db.ref(`groupMessages/${groupId}`).on("value", snap => {
      const messages = snap.val() || {};
      const lastMessage = Object.values(messages).pop();
      
      if (!lastMessage) return;
      
      // Store last message timestamp for this group
      lastGroupMessageTimestamps[groupId] = lastMessage.timestamp || Date.now();
      
      // If the message is not from current user and group is not open
      if (lastMessage.from !== currentUser && currentGroup !== groupId) {
        // Increment unread count
        unreadGroupMessages[groupId] = (unreadGroupMessages[groupId] || 0) + 1;
        
        // Update group list item
        updateGroupListItem(groupId);
        
        // Show notification
        showMessageNotification(lastMessage.from + " (Group)", lastMessage.text, lastMessage.timestamp);
      }
    });
  }

  // Update friend list item with current status
  function updateFriendListItem(friend) {
    const friendItem = document.getElementById(`friend-${friend}`);
    if (!friendItem) return;
    
    const friendRef = db.ref(`users/${friend}`);
    friendRef.once("value").then(snapshot => {
      const info = snapshot.val();
      const isActive = info && Date.now() - info.lastActive < 60000;
      
      // Add unread badge if there are unread messages
      const unreadBadge = unreadMessages[friend] > 0 
        ? `<div class="unread-badge">${unreadMessages[friend]}</div>` 
        : '';
      
      friendItem.innerHTML = `
        <div class="friend-avatar">
          ${friend.charAt(0).toUpperCase()}
          ${isActive ? '<div class="online-dot"></div>' : ''}
        </div>
        <div class="friend-info">
          <div class="friend-name">${friend}</div>
          <div class="friend-status">${isActive ? 'Active now' : 'Last seen recently'}</div>
        </div>
        <div class="friend-time">${formatDate(lastMessageTimestamps[friend] || Date.now())}</div>
        ${unreadBadge}
      `;
      
      friendItem.onclick = () => {
        startChat(friend);
        if (isMobile) {
          document.getElementById('sidebar').classList.remove('open');
        }
      };
    });
  }

  // Update group list item
  function updateGroupListItem(groupId) {
    const groupItem = document.getElementById(`group-${groupId}`);
    if (!groupItem) return;
    
    db.ref(`groups/${groupId}`).once("value").then(snapshot => {
      const groupData = snapshot.val();
      if (!groupData) return;
      
      // Count members
      const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
      
      // Add unread badge if there are unread messages
      const unreadBadge = unreadGroupMessages[groupId] > 0 
        ? `<div class="unread-badge">${unreadGroupMessages[groupId]}</div>` 
        : '';
      
      groupItem.innerHTML = `
        <div class="friend-avatar group-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="friend-info">
          <div class="friend-name">${groupData.name}</div>
          <div class="friend-status">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
        </div>
        <div class="friend-time">${formatDate(lastGroupMessageTimestamps[groupId] || groupData.createdAt || Date.now())}</div>
        ${unreadBadge}
      `;
      
      groupItem.onclick = () => {
        startGroupChat(groupId);
        if (isMobile) {
          document.getElementById('sidebar').classList.remove('open');
        }
      };
    });
  }

  // Setup message notifications
  function setupMessageNotifications() {
    // Handle browser tab visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // Clear any notifications when tab becomes active
        document.title = "MessageMe";
      }
    });
  }

  // Show message notification
  function showMessageNotification(sender, message, timestamp) {
    // Update browser tab title
    const unreadCount = unreadMessages[sender] || unreadGroupMessages[sender] || 1;
    document.title = `(${unreadCount}) New message from ${sender} | MessageMe`;
    
    // Show popup notification
    const popup = document.getElementById("notification");
    document.getElementById("notificationSender").textContent = sender;
    document.getElementById("notificationMessage").textContent = message.length > 80 ? message.substring(0, 80) + '...' : message;
    document.getElementById("notificationTime").textContent = formatTime(timestamp);
    
    popup.classList.add("show");
    
    // Play notification sound
    playNotificationSound();
    
    // Vibrate if on mobile
    if (navigator.vibrate) {
      navigator.vibrate(200);
    }
    
    // Auto hide after 5 seconds
    setTimeout(() => {
      popup.classList.remove("show");
    }, 5000);
  }

  // Play notification sound
  function playNotificationSound() {
    const audio = document.getElementById("notificationSound");
    audio.volume = 0.3;
    audio.currentTime = 0;
    audio.play().catch(e => console.log("Audio play failed:", e));
  }

  // Close notification
  function closeNotification() {
    document.getElementById("notification").classList.remove("show");
  }

  // Start private chat with a friend
  function startChat(user) {
    chattingWith = user;
    currentGroup = "";
    document.getElementById("emptyState").style.display = "none";
    document.getElementById("privateChat").style.display = "flex";
    document.getElementById("groupChat").style.display = "none";
    document.getElementById("chatWithName").textContent = user;
    document.getElementById("chatWithInitial").textContent = user.charAt(0).toUpperCase();
    document.getElementById("chatWithAvatar").innerHTML = user.charAt(0).toUpperCase();
    
    // Reset unread count for this friend
    unreadMessages[user] = 0;
    updateFriendListItem(user);
    
    // Update browser title
    document.title = `MessageMe - Chat with ${user}`;
    
    // Monitor friend's status
    monitorFriendStatus(user);
    
    const chatKey = [currentUser, user].sort().join('_');
    db.ref(`messages/${chatKey}`).on("value", snap => {
      const chatBox = document.getElementById("chatMessages");
      chatBox.innerHTML = "";
      const data = snap.val() || {};
      allMessages[user] = data; // Store messages for search
      
      Object.entries(data).forEach(([key, msg]) => {
        const isSent = msg.from === currentUser;
        const div = document.createElement("div");
        div.className = `message ${isSent ? 'sent' : 'received'}`;
        
        // Add reaction if exists
        const reaction = msg.reaction ? `<div class="reaction-display">${msg.reaction}</div>` : '';
        
        div.innerHTML = `
          <div class="message-bubble">
            ${msg.isImage ? 
              `<img src="${msg.text}" style="max-width: 100%; border-radius: 8px; margin-bottom: 4px;" />` : 
              `<p>${msg.text}</p>`}
          </div>
          ${reaction}
          <div class="message-time">${formatTime(msg.timestamp || Date.now())}</div>
          <div class="reaction-container">
            <button class="reaction-btn" onclick="addReaction('${chatKey}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addReaction('${chatKey}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addReaction('${chatKey}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addReaction('${chatKey}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addReaction('${chatKey}', '${key}', '')"></button>
          </div>
        `;
        
        chatBox.appendChild(div);
      });
      
      // Scroll to bottom
      setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 100);
    });
  }

  // Add reaction to message
  function addReaction(chatKey, messageId, reaction) {
    db.ref(`messages/${chatKey}/${messageId}`).update({
      reaction: reaction
    });
  }

  // Start group chat
  function startGroupChat(groupId) {
    currentGroup = groupId;
    chattingWith = "";
    document.getElementById("emptyState").style.display = "none";
    document.getElementById("privateChat").style.display = "none";
    document.getElementById("groupChat").style.display = "flex";
    
    // Reset unread count for this group
    unreadGroupMessages[groupId] = 0;
    updateGroupListItem(groupId);
    
    // Load group info
    db.ref(`groups/${groupId}`).once("value").then(snapshot => {
      const groupData = snapshot.val();
      if (!groupData) return;
      
      document.getElementById("groupChatName").textContent = groupData.name;
      
      // Count members
      const memberCount = groupData.members ? Object.keys(groupData.members).length : 0;
      document.getElementById("groupMembersCount").textContent = `${memberCount} member${memberCount !== 1 ? 's' : ''}`;
      
      // Update browser title
      document.title = `MessageMe - ${groupData.name}`;
    });
    
    // Load group messages
    db.ref(`groupMessages/${groupId}`).on("value", snap => {
      const chatBox = document.getElementById("groupMessages");
      chatBox.innerHTML = "";
      const data = snap.val() || {};
      allGroupMessages[groupId] = data; // Store messages for search
      
      Object.entries(data).forEach(([key, msg]) => {
        const isSent = msg.from === currentUser;
        const div = document.createElement("div");
        div.className = `message ${isSent ? 'sent' : 'received'}`;
        
        // Add reaction if exists
        const reaction = msg.reaction ? `<div class="reaction-display">${msg.reaction}</div>` : '';
        
        div.innerHTML = `
          <div class="message-bubble">
            ${!isSent ? `<div class="group-message-name">${msg.from}</div>` : ''}
            ${msg.isImage ? 
              `<img src="${msg.text}" style="max-width: 100%; border-radius: 8px; margin-bottom: 4px;" />` : 
              `<p>${msg.text}</p>`}
          </div>
          ${reaction}
          <div class="message-time">${formatTime(msg.timestamp || Date.now())}</div>
          <div class="reaction-container">
            <button class="reaction-btn" onclick="addGroupReaction('${groupId}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addGroupReaction('${groupId}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addGroupReaction('${groupId}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addGroupReaction('${groupId}', '${key}', '')"></button>
            <button class="reaction-btn" onclick="addGroupReaction('${groupId}', '${key}', '')"></button>
          </div>
        `;
        
        chatBox.appendChild(div);
      });
      
      // Scroll to bottom
      setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 100);
    });
  }

  // Add reaction to group message
  function addGroupReaction(groupId, messageId, reaction) {
    db.ref(`groupMessages/${groupId}/${messageId}`).update({
      reaction: reaction
    });
  }

  // Handle image upload for private chat
  function handleImageUpload() {
    const fileInput = document.getElementById('imageInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (!file.type.match('image.*')) {
      showToast('Please select an image file');
      return;
    }
    
    // Show loading state
    const previewContainer = document.getElementById('imagePreviewContainer');
    previewContainer.innerHTML = '<div style="color: var(--text-secondary);">Uploading image...</div>';
    
    // Upload to Firebase Storage
    const storageRef = storage.ref(`images/${currentUser}_${Date.now()}_${file.name}`);
    const uploadTask = storageRef.put(file);
    
    uploadTask.on('state_changed', 
      (snapshot) => {
        // Progress monitoring can be added here
      }, 
      (error) => {
        console.error("Upload failed:", error);
        showToast("Image upload failed");
        previewContainer.innerHTML = '';
      }, 
      () => {
        // Upload completed successfully
        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
          selectedImage = downloadURL;
          previewContainer.innerHTML = `
            <img src="${selectedImage}" class="image-preview show" />
            <button class="remove-image-btn" onclick="removeSelectedImage()">Remove Image</button>
          `;
        });
      }
    );
  }

  // Handle image upload for group chat
  function handleGroupImageUpload() {
    const fileInput = document.getElementById('groupImageInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (!file.type.match('image.*')) {
      showToast('Please select an image file');
      return;
    }
    
    // Show loading state
    const previewContainer = document.getElementById('groupImagePreviewContainer');
    previewContainer.innerHTML = '<div style="color: var(--text-secondary);">Uploading image...</div>';
    
    // Upload to Firebase Storage
    const storageRef = storage.ref(`images/${currentUser}_${Date.now()}_${file.name}`);
    const uploadTask = storageRef.put(file);
    
    uploadTask.on('state_changed', 
      (snapshot) => {
        // Progress monitoring can be added here
      }, 
      (error) => {
        console.error("Upload failed:", error);
        showToast("Image upload failed");
        previewContainer.innerHTML = '';
      }, 
      () => {
        // Upload completed successfully
        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
          selectedGroupImage = downloadURL;
          previewContainer.innerHTML = `
            <img src="${selectedGroupImage}" class="image-preview show" />
            <button class="remove-image-btn" onclick="removeSelectedGroupImage()">Remove Image</button>
          `;
        });
      }
    );
  }

  // Remove selected image from private chat
  function removeSelectedImage() {
    selectedImage = null;
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreviewContainer').innerHTML = '';
  }

  // Remove selected image from group chat
  function removeSelectedGroupImage() {
    selectedGroupImage = null;
    document.getElementById('groupImageInput').value = '';
    document.getElementById('groupImagePreviewContainer').innerHTML = '';
  }

  // Search messages
  function searchMessages() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (!searchTerm) return;
    
    let foundMessages = [];
    
    // Search through all messages
    Object.entries(allMessages).forEach(([friend, messages]) => {
      Object.entries(messages).forEach(([key, msg]) => {
        if (msg.text && !msg.isImage && msg.text.toLowerCase().includes(searchTerm)) {
          foundMessages.push({
            friend,
            message: msg
          });
        }
      });
    });
    
    // Search through group messages
    Object.entries(allGroupMessages).forEach(([groupId, messages]) => {
      Object.entries(messages).forEach(([key, msg]) => {
        if (msg.text && !msg.isImage && msg.text.toLowerCase().includes(searchTerm)) {
          db.ref(`groups/${groupId}`).once("value").then(snapshot => {
            const groupData = snapshot.val();
            foundMessages.push({
              groupId,
              groupName: groupData.name,
              message: msg
            });
          });
        }
      });
    });
    
    // Display search results
    const chatBox = document.getElementById("chatMessages");
    chatBox.innerHTML = "";
    
    if (foundMessages.length === 0) {
      chatBox.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
          No messages found
        </div>
      `;
      return;
    }
    
    foundMessages.forEach(item => {
      const isSent = item.message.from === currentUser;
      const div = document.createElement("div");
      div.className = `message ${isSent ? 'sent' : 'received'}`;
      div.style.marginBottom = "16px";
      
      // Highlight the search term in the message
      const messageText = item.message.text.replace(
        new RegExp(searchTerm, 'gi'),
        match => `<span style="background-color: rgba(0, 180, 255, 0.2); padding: 0 2px; border-radius: 3px;">${match}</span>`
      );
      
      if (item.groupId) {
        // Group message result
        div.innerHTML = `
          <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
            Group: ${item.groupName}  ${formatTime(item.message.timestamp)}
          </div>
          <div class="message-bubble">
            <div class="group-message-name">${isSent ? 'You' : item.message.from}</div>
            <p>${messageText}</p>
          </div>
        `;
        
        div.onclick = () => {
          startGroupChat(item.groupId);
          document.getElementById('searchInput').value = '';
          if (isMobile) {
            document.getElementById('sidebar').classList.remove('open');
          }
        };
      } else {
        // Private message result
        div.innerHTML = `
          <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
            Chat with ${item.friend}  ${formatTime(item.message.timestamp)}
          </div>
          <div class="message-bubble">
            <p>${messageText}</p>
          </div>
        `;
        
        div.onclick = () => {
          startChat(item.friend);
          document.getElementById('searchInput').value = '';
          if (isMobile) {
            document.getElementById('sidebar').classList.remove('open');
          }
        };
      }
      
      chatBox.appendChild(div);
    });
  }

  // Monitor friend's online status
  function monitorFriendStatus(friend) {
    // Clear any existing interval
    if (friendStatusInterval) clearInterval(friendStatusInterval);
    
    const friendRef = db.ref(`users/${friend}`);
    const statusDot = document.getElementById("friendStatus");
    const statusText = document.getElementById("friendStatusText");
    
    friendRef.on("value", snapshot => {
      const info = snapshot.val();
      const isActive = info && Date.now() - info.lastActive < 60000;
      
      statusDot.style.display = isActive ? "block" : "none";
      statusText.textContent = isActive ? "Active now" : "Last seen recently";
      statusText.style.color = isActive ? "var(--online)" : "var(--text-secondary)";
      
      // Highlight friend in friends list
      const friendElement = document.getElementById(`friend-${friend}`);
      if (friendElement) {
        friendElement.classList.toggle("active", isActive);
      }
    });
    
    // Check status every 10 seconds
    friendStatusInterval = setInterval(() => {
      friendRef.once("value").then(snapshot => {
        const info = snapshot.val();
        const isActive = info && Date.now() - info.lastActive < 60000;
        
        statusDot.style.display = isActive ? "block" : "none";
        statusText.textContent = isActive ? "Active now" : "Last seen recently";
        statusText.style.color = isActive ? "var(--online)" : "var(--text-secondary)";
      });
    }, 10000);
  }

  // Hide private chat
  function hideChat() {
    document.getElementById("privateChat").style.display = "none";
    document.getElementById("emptyState").style.display = "flex";
    document.title = "MessageMe";
    if (friendStatusInterval) clearInterval(friendStatusInterval);
    removeSelectedImage();
  }

  // Hide group chat
  function hideGroupChat() {
    document.getElementById("groupChat").style.display = "none";
    document.getElementById("emptyState").style.display = "flex";
    document.title = "MessageMe";
    removeSelectedGroupImage();
  }

  // Send private message
  function sendMessage() {
    const textInput = document.getElementById("messageInput");
    const text = textInput.value.trim();
    
    if ((!text && !selectedImage) || !chattingWith) return;

    const chatKey = [currentUser, chattingWith].sort().join('_');
    
    if (selectedImage) {
      // Send image
      db.ref(`messages/${chatKey}`).push({ 
        from: currentUser, 
        text: selectedImage,
        isImage: true,
        timestamp: Date.now()
      });
      removeSelectedImage();
    } else {
      // Send text message
      db.ref(`messages/${chatKey}`).push({ 
        from: currentUser, 
        text,
        timestamp: Date.now()
      });
      textInput.value = "";
    }
  }

  // Send group message
  function sendGroupMessage() {
    const textInput = document.getElementById("groupMessageInput");
    const text = textInput.value.trim();
    
    if ((!text && !selectedGroupImage) || !currentGroup) return;

    if (selectedGroupImage) {
      // Send image
      db.ref(`groupMessages/${currentGroup}`).push({ 
        from: currentUser, 
        text: selectedGroupImage,
        isImage: true,
        timestamp: Date.now()
      });
      removeSelectedGroupImage();
    } else {
      // Send text message
      db.ref(`groupMessages/${currentGroup}`).push({ 
        from: currentUser, 
        text,
        timestamp: Date.now()
      });
      textInput.value = "";
    }
  }

  // Toggle dark/light theme
  function toggleTheme() {
    document.body.classList.toggle("theme-dark");
    document.body.classList.toggle("theme-light");
    
    const icon = document.querySelector('.theme-toggle i');
    if (document.body.classList.contains("theme-dark")) {
      icon.classList.remove("fa-moon");
      icon.classList.add("fa-sun");
      localStorage.setItem('messageMeTheme', 'dark');
    } else {
      icon.classList.remove("fa-sun");
      icon.classList.add("fa-moon");
      localStorage.setItem('messageMeTheme', 'light');
    }
  }

  // Format time for display
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Format date for display
  function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      return 'Today';
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return date.toLocaleDateString([], { weekday: 'short' });
    } else {
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }
  }

  // Show toast notification
  function showToast(message) {
    const toast = document.createElement("div");
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.backgroundColor = "var(--bg-primary)";
    toast.style.color = "var(--text-primary)";
    toast.style.padding = "12px 24px";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 4px 12px rgba(0, 0, 0, 0.15)";
    toast.style.zIndex = "1000";
    toast.style.opacity = "0";
    toast.style.transition = "opacity 0.3s";
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = "1";
    }, 10);
    
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Show create group modal
  function showCreateGroupModal() {
    const modal = document.getElementById("createGroupModal");
    modal.classList.add("show");
    
    // Populate friends list
    const friendsSelect = document.getElementById("friendsSelectList");
    friendsSelect.innerHTML = "";
    
    friendsList.forEach(friend => {
      const item = document.createElement("div");
      item.className = "friend-option";
      item.innerHTML = `
        <div class="friend-option-avatar">${friend.charAt(0).toUpperCase()}</div>
        <span>${friend}</span>
      `;
      
      item.onclick = () => {
        item.classList.toggle("selected");
        if (item.classList.contains("selected")) {
          if (!selectedFriendsForGroup.includes(friend)) {
            selectedFriendsForGroup.push(friend);
          }
        } else {
          selectedFriendsForGroup = selectedFriendsForGroup.filter(f => f !== friend);
        }
        updateSelectedFriendsDisplay();
      };
      
      friendsSelect.appendChild(item);
    });
  }

  // Close create group modal
  function closeCreateGroupModal() {
    document.getElementById("createGroupModal").classList.remove("show");
    document.getElementById("groupNameInput").value = "";
    selectedFriendsForGroup = [];
    document.getElementById("selectedFriends").innerHTML = "";
  }

  // Update selected friends display in modal
  function updateSelectedFriendsDisplay() {
    const container = document.getElementById("selectedFriends");
    container.innerHTML = "";
    
    selectedFriendsForGroup.forEach(friend => {
      const tag = document.createElement("div");
      tag.className = "friend-tag";
      tag.innerHTML = `
        ${friend}
        <span class="remove-tag" onclick="removeSelectedFriend('${friend}')">
          <i class="fas fa-times"></i>
        </span>
      `;
      container.appendChild(tag);
    });
  }

  // Remove selected friend from group creation
  function removeSelectedFriend(friend) {
    selectedFriendsForGroup = selectedFriendsForGroup.filter(f => f !== friend);
    updateSelectedFriendsDisplay();
    
    // Also unselect from the list
    const items = document.querySelectorAll(".friend-option");
    items.forEach(item => {
      if (item.textContent.includes(friend)) {
        item.classList.remove("selected");
      }
    });
  }

  // Create new group
  function createGroup() {
    const groupName = document.getElementById("groupNameInput").value.trim();
    if (!groupName) {
      showToast("Please enter a group name");
      return;
    }
    
    if (selectedFriendsForGroup.length === 0) {
      showToast("Please select at least one friend");
      return;
    }
    
    // Create group
    const groupRef = db.ref("groups").push();
    const groupId = groupRef.key;
    
    // Prepare members object (including current user)
    const members = {};
    members[currentUser] = true;
    selectedFriendsForGroup.forEach(friend => {
      members[friend] = true;
    });
    
    // Set group data
    groupRef.set({
      name: groupName,
      createdAt: Date.now(),
      createdBy: currentUser,
      members: members
    });
    
    // Add group to each user's groups
    Object.keys(members).forEach(user => {
      db.ref(`userGroups/${user}/${groupId}`).set(true);
    });
    
    // Close modal and reset
    closeCreateGroupModal();
    showToast(`Group "${groupName}" created successfully`);
    
    // Start chatting in the new group
    startGroupChat(groupId);
  }
  
  /* ========== CALL FUNCTIONS ========== */
  
  // Setup call listener
  function setupCallListener() {
    callListener = db.ref(`calls/${currentUser}`).on('value', snapshot => {
      const callData = snapshot.val();
      if (!callData) return;
      
      const callId = Object.keys(callData)[0];
      const call = callData[callId];
      
      // If call is incoming and not from ourselves
      if (call.status === 'calling' && call.from !== currentUser) {
        showIncomingCall(call.from, call.isVideo);
      }
    });
  }
  
  // Show incoming call UI
  function showIncomingCall(caller, isVideo) {
    // Set call data
    currentCallId = `${caller}_${currentUser}`;
    isCaller = false;
    isVideoCall = isVideo;
    
    // Update UI
    document.getElementById('callerAvatar').textContent = caller.charAt(0).toUpperCase();
    document.getElementById('callerName').textContent = caller;
    document.getElementById('callStatus').textContent = isVideo ? 'Incoming video call' : 'Incoming voice call';
    
    // Show appropriate buttons
    document.querySelector('.accept-call').style.display = 'flex';
    document.querySelector('.decline-call').style.display = 'flex';
    document.querySelector('.end-call').style.display = 'none';
    
    // Show video container if video call
    document.getElementById('videoContainer').style.display = isVideo ? 'block' : 'none';
    
    // Show modal
    document.getElementById('callModal').classList.add('show');
    
    // Play ringtone
    document.getElementById('ringtone').play();
    
    // Setup call status listener
    callStatusListener = db.ref(`calls/${currentUser}/${currentCallId}/status`).on('value', snapshot => {
      const status = snapshot.val();
      if (status === 'ended') {
        endCall();
      }
    });
  }
  
  // Start a call (either voice or video)
  function startCall(isVideo) {
    if (!chattingWith) return;
    
    // Set call data
    currentCallId = `${currentUser}_${chattingWith}`;
    isCaller = true;
    isVideoCall = isVideo;
    
    // Update UI
    document.getElementById('callerAvatar').textContent = chattingWith.charAt(0).toUpperCase();
    document.getElementById('callerName').textContent = chattingWith;
    document.getElementById('callStatus').textContent = 'Calling...';
    
    // Show appropriate buttons
    document.querySelector('.accept-call').style.display = 'none';
    document.querySelector('.decline-call').style.display = 'none';
    document.querySelector('.end-call').style.display = 'flex';
    
    // Show video container if video call
    document.getElementById('videoContainer').style.display = isVideo ? 'block' : 'none';
    
    // Show modal
    document.getElementById('callModal').classList.add('show');
    
    // Initialize call
    db.ref(`calls/${chattingWith}/${currentCallId}`).set({
      from: currentUser,
      to: chattingWith,
      isVideo: isVideo,
      status: 'calling',
      timestamp: Date.now()
    });
    
    // Setup call status listener
    callStatusListener = db.ref(`calls/${currentUser}/${currentCallId}/status`).on('value', snapshot => {
      const status = snapshot.val();
      if (status === 'accepted') {
        startWebRTC();
      } else if (status === 'ended') {
        endCall();
      }
    });
    
    // Setup timeout for unanswered call
    setTimeout(() => {
      if (document.getElementById('callModal').classList.contains('show') && 
          document.getElementById('callStatus').textContent === 'Calling...') {
        showToast('Call not answered');
        endCall();
      }
    }, 30000);
  }
  
  // Accept incoming call
  function acceptCall() {
    // Stop ringtone
    document.getElementById('ringtone').pause();
    
    // Update call status
    db.ref(`calls/${currentUser}/${currentCallId}`).update({
      status: 'accepted'
    });
    
    // Update UI
    document.getElementById('callStatus').textContent = isVideoCall ? 'Video call in progress' : 'Voice call in progress';
    document.querySelector('.accept-call').style.display = 'none';
    document.querySelector('.decline-call').style.display = 'none';
    document.querySelector('.end-call').style.display = 'flex';
    
    // Start WebRTC
    startWebRTC();
  }
  
  // End the current call
  function endCall() {
    // Stop ringtone
    document.getElementById('ringtone').pause();
    
    // Update call status
    if (currentCallId) {
      const otherUser = isCaller ? chattingWith : currentCallId.split('_')[0];
      db.ref(`calls/${otherUser}/${currentCallId}`).update({
        status: 'ended'
      });
      
      // Remove call data
      db.ref(`calls/${currentUser}/${currentCallId}`).remove();
    }
    
    // Close modal
    document.getElementById('callModal').classList.remove('show');
    
    // Clean up WebRTC
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    
    if (remoteStream) {
      remoteStream.getTracks().forEach(track => track.stop());
      remoteStream = null;
    }
    
    // Reset call data
    currentCallId = null;
    isCaller = false;
    isVideoCall = false;
  }
  
  // Start WebRTC connection
  async function startWebRTC() {
    try {
      // Get local media
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: true,
        video: isVideoCall
      });
      
      if (isVideoCall) {
        document.getElementById('localVideo').srcObject = localStream;
      }
      
      // Create peer connection
      const configuration = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' }
        ]
      };
      
      peerConnection = new RTCPeerConnection(configuration);
      
      // Add local stream to connection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
      
      // Handle remote stream
      peerConnection.ontrack = event => {
        remoteStream = event.streams[0];
        if (isVideoCall) {
          document.getElementById('remoteVideo').srcObject = remoteStream;
        }
      };
      
      // Handle ICE candidates
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          const otherUser = isCaller ? chattingWith : currentCallId.split('_')[0];
          db.ref(`calls/${otherUser}/${currentCallId}/iceCandidates`).push({
            candidate: event.candidate,
            from: currentUser
          });
        }
      };
      
      // Listen for ICE candidates from the other user
      callIceCandidatesListener = db.ref(`calls/${currentUser}/${currentCallId}/iceCandidates`).on('child_added', snapshot => {
        const candidateData = snapshot.val();
        if (candidateData.from !== currentUser && peerConnection) {
          peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
        }
      });
      
      if (isCaller) {
        // Create offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        const otherUser = chattingWith;
        db.ref(`calls/${otherUser}/${currentCallId}/offer`).set({
          sdp: offer.sdp,
          type: offer.type
        });
        
        // Listen for answer
        db.ref(`calls/${currentUser}/${currentCallId}/answer`).once('value').then(snapshot => {
          const answerData = snapshot.val();
          if (answerData) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answerData));
          }
        });
      } else {
        // Listen for offer
        const otherUser = currentCallId.split('_')[0];
        db.ref(`calls/${currentUser}/${currentCallId}/offer`).once('value').then(async snapshot => {
          const offerData = snapshot.val();
          if (offerData) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));
            
            // Create answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            db.ref(`calls/${otherUser}/${currentCallId}/answer`).set({
              sdp: answer.sdp,
              type: answer.type
            });
          }
        });
      }
    } catch (error) {
      console.error('WebRTC error:', error);
      showToast('Call failed');
      endCall();
    }
  }
</script>
</body>
</html>
